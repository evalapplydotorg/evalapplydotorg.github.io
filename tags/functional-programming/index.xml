<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>functional-programming on eval/apply</title><link>/tags/functional-programming/</link><description>Recent content in functional-programming on eval/apply</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Tue, 22 Mar 2022 03:50:31 +0530</lastBuildDate><atom:link href="/tags/functional-programming/index.xml" rel="self" type="application/rss+xml"/><item><title>n ways to FizzBuzz in Clojure</title><link>/posts/n-ways-to-fizzbuzz-in-clojure/</link><pubDate>Tue, 22 Mar 2022 03:50:31 +0530</pubDate><guid>/posts/n-ways-to-fizzbuzz-in-clojure/</guid><description>&lt;p>FizzBuzz is everywhere. Every programmer passes through its rite of passage,
or at least bears witness to another. Over the years, many gentlenerds have
taken it upon themselves to discover ever new ways to incant those hoary symbols.&lt;/p>
&lt;p>I hereby enjoin these few drops of Clojure to that roiling ocean of FizzBuzzery.&lt;/p>
&lt;p>The brainwave here is to (mis)use the feature set of Clojure and its standard
library to cook up as many ways to encode FizzBuzz as one can muster (or steal).
If all goes well, this post will receive many updates. If it goes &lt;em>really&lt;/em>
well, all sorts of bad ideas and clever foot-guns will be discovered and used.&lt;/p></description><content>&lt;p>FizzBuzz is everywhere. Every programmer passes through its rite of passage,
or at least bears witness to another. Over the years, many gentlenerds have
taken it upon themselves to discover ever new ways to incant those hoary symbols.&lt;/p>
&lt;p>I hereby enjoin these few drops of Clojure to that roiling ocean of FizzBuzzery.&lt;/p>
&lt;p>The brainwave here is to (mis)use the feature set of Clojure and its standard
library to cook up as many ways to encode FizzBuzz as one can muster (or steal).
If all goes well, this post will receive many updates. If it goes &lt;em>really&lt;/em>
well, all sorts of bad ideas and clever foot-guns will be discovered and used.&lt;/p>
&lt;p>Not to be indelicate, but I will state the problem before proceeding.&lt;/p>
&lt;blockquote>
&lt;p>Fizz buzz is a group word game for children to teach them about division.
Players take turns to count incrementally, replacing any number divisible by
three with the word &amp;ldquo;fizz&amp;rdquo;, and any number divisible by five with the word &amp;ldquo;buzz&amp;rdquo;.&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://en.wikipedia.org/wiki/Fizz%5Fbuzz">https://en.wikipedia.org/wiki/Fizz%5Fbuzz&lt;/a>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Needless to say, they mean natural numbers starting at 1 when they say &amp;ldquo;numbers&amp;rdquo;.&lt;/p>
&lt;p>Phew that was rough on the ego. Let us compose ourselves for a minute.&lt;/p>
&lt;p>&amp;hellip;&lt;/p>
&lt;p>OK, onward.&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;ul>
&lt;li>&lt;a href="#usage-guide">Usage guide&lt;/a>&lt;/li>
&lt;li>&lt;a href="#le-fizzbuzz-classique">Le FizzBuzz Classique&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#le-fizzbuzz-classique-est-mort-%C3%A0-clojure-dot-d%C3%A9sol%C3%A9">Le FizzBuzz Classique est mort à Clojure. Désolé :(&lt;/a>&lt;/li>
&lt;li>&lt;a href="#le-fizzbuzz-classique-remedied">Le FizzBuzz Classique, remedied&lt;/a>&lt;/li>
&lt;li>&lt;a href="#le-fizzbuzz-classique-dissected">Le FizzBuzz Classique, dissected&lt;/a>&lt;/li>
&lt;li>&lt;a href="#le-fizzbuzz-classique-doseq-d">Le FizzBuzz Classique, doseq&amp;rsquo;d&lt;/a>&lt;/li>
&lt;li>&lt;a href="#le-fizzbuzz-classique-doall-d">Le FizzBuzz Classique, doall&amp;rsquo;d&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#little-functions-are-good">Little functions are good!&lt;/a>&lt;/li>
&lt;li>&lt;a href="#map-reduce-for-fizzbuzz">map reduce for FizzBuzz&lt;/a>&lt;/li>
&lt;li>&lt;a href="#domain-driven-design-fizzbuzz">Domain Driven Design FizzBuzz&lt;/a>&lt;/li>
&lt;li>&lt;a href="#actually-domain-driven-fizzbuzz">Actually Domain Driven FizzBuzz&lt;/a>&lt;/li>
&lt;li>&lt;a href="#fizzbuzz-by-construction">FizzBuzz by construction&lt;/a>&lt;/li>
&lt;li>&lt;a href="#interlude-all-the-fizz-buzzes-so-far">Interlude: all the fizz-buzzes so far&lt;/a>&lt;/li>
&lt;li>&lt;a href="#peano-fizzbuzz">Peano FizzBuzz&lt;/a>&lt;/li>
&lt;li>&lt;a href="#dispatch-buzz">Dispatch Buzz&lt;/a>&lt;/li>
&lt;li>&lt;a href="#embarrassingly-parallel-fizzbuzz">Embarrassingly Parallel FizzBuzz&lt;/a>&lt;/li>
&lt;li>&lt;a href="#oop-buzz">OOP Buzz&lt;/a>&lt;/li>
&lt;li>&lt;a href="#non-destructive-fizzbuzz">Non-Destructive FizzBuzz&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#composite-data-buzz">Composite Data Buzz&lt;/a>&lt;/li>
&lt;li>&lt;a href="#clojure-spec-d-buzz">Clojure Spec&amp;rsquo;d Buzz&lt;/a>&lt;/li>
&lt;li>&lt;a href="#wicked-pprint-buzz">Wicked pprint Buzz&lt;/a>&lt;/li>
&lt;li>&lt;a href="#tagged-literal-buzz">Tagged Literal Buzz&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#buzz">&lt;!-- raw HTML omitted -->TODO&lt;!-- raw HTML omitted --> Buzz&lt;/a>&lt;/li>
&lt;li>&lt;a href="#acknowledgments">Acknowledgments&lt;/a>&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;hr>
&lt;h2 id="usage-guide">Usage guide&lt;/h2>
&lt;p>Reading the code:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Find the &lt;code>check-all-fizz-buzzers&lt;/code> function below, for usage examples.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>We use functions only from Clojure&amp;rsquo;s standard library (clojure.core).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Lookup unfamiliar functions at &lt;a href="https://clojuredocs.org/quickref">https://clojuredocs.org/quickref&lt;/a>, helpfully
illustrated with community-contributed examples.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>Running the code:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>If you don&amp;rsquo;t already have &lt;a href="https://clojure.org/guides/getting%5Fstarted">Clojure installed&lt;/a>,
you can run the code online at &lt;a href="https://tryclojure.org/">https://tryclojure.org/&lt;/a> (fully client-side,
but minimalist), or at &lt;a href="https://repl.it/languages/clojure">https://repl.it/languages/clojure&lt;/a> (feature-rich
web-based IDE, but requires signup).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Preferably, copy over code as you go along. Try it out bit by bit.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>If you are in a hurry, find the &amp;ldquo;Interlude&amp;rdquo; section and copy over all the
code from there.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Finally, run &lt;code>(check-all-fizz-buzzers)&lt;/code> to see if it all works as expected.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>Complaining about the code:&lt;/p>
&lt;ul>
&lt;li>If I&amp;rsquo;ve written any bugs (possible) or made egregious remarks (very possible),
please write to &lt;em>weblog&lt;/em> at this website. I&amp;rsquo;ll fix the bugs.&lt;/li>
&lt;/ul>
&lt;p>Right, then. Shall we begin?&lt;/p>
&lt;h2 id="le-fizzbuzz-classique">Le FizzBuzz Classique&lt;/h2>
&lt;p>In the beginning, one might trawl the Clojure standard library for familiar,
safe-looking words and accidentally discover &lt;code>for&lt;/code>&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>.
Python or Javascript gentlenerds may say &lt;em>&amp;ldquo;Ooh, List Comprehension. Nice!&amp;quot;&lt;/em>,
and bang out &lt;em>Le FizzBuzz Classique&lt;/em>. Java or C# gentlenerds may struggle a
lot more, because Clojure has no &lt;code>Class&lt;/code>. We are sorry for this disappointment.
Please follow the Python for now.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>fizz-buzz-classic
[num-xs]
(for [n num-xs]
(&lt;span style="color:#a6e22e">cond&lt;/span>
(zero? (rem n &lt;span style="color:#ae81ff">15&lt;/span>)) (println &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>)
(zero? (rem n &lt;span style="color:#ae81ff">3&lt;/span>)) (println &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>)
(zero? (rem n &lt;span style="color:#ae81ff">5&lt;/span>)) (println &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>)
&lt;span style="color:#e6db74">:else&lt;/span> (println n))))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Then you will evaluate it &lt;em>in&lt;/em> the &amp;ldquo;REPL&amp;rdquo;, et voilà! Something
très familiar!&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">user=&amp;gt; (&lt;span style="color:#a6e22e">fizz-buzz-classic&lt;/span> (list &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#ae81ff">16&lt;/span>))
&lt;span style="color:#ae81ff">1&lt;/span>
Fizz
Buzz
FizzBuzz
&lt;span style="color:#ae81ff">16&lt;/span>
(&lt;span style="color:#a6e22e">nil&lt;/span> nil nil nil nil)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>(Except for that pesky last line full of nils. But like, whatever. It worked.).&lt;/p>
&lt;h3 id="le-fizzbuzz-classique-est-mort-à-clojure-dot-désolé">Le FizzBuzz Classique est mort à Clojure. Désolé :(&lt;/h3>
&lt;p>Sadly, the spurious nils are the least of your woes. You just fell prey to
something called &amp;ldquo;Laziness&amp;rdquo;, and the code is dead on arrival, but you don&amp;rsquo;t
know it yet because evaluating &lt;em>in&lt;/em> the &amp;ldquo;REPL&amp;rdquo; obscures this fact.&lt;/p>
&lt;p>Welcome to Functional Programming (FP) with lazy sequences, which is &lt;em>awesome&lt;/em>,
but which is also one of the double edges of Clojure that will cut you if you
come here with set ideas about How Things Ought To Work.&lt;/p>
&lt;p>Saying it in French (however broken) felt gentler, somehow.&lt;/p>
&lt;p>At this point, you might accuse me of setting you up with this strawman &lt;code>for&lt;/code>.
In response, I might simply wait for your production to blow up. Unknowing
mixing of laziness and side effects reliably trips up all programmers new to
Clojure &lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup>.&lt;/p>
&lt;p>Luckily we can avoid going down that rabbit hole &lt;sup id="fnref:3">&lt;a href="#fn:3" class="footnote-ref" role="doc-noteref">3&lt;/a>&lt;/sup> entirely, because
there is a more pressing problem that makes &lt;em>Le FizzBuzz Classique&lt;/em> look
severely defective to this Clojurist&amp;rsquo;s FP-addled brain. Fixing that makes the
point of lazy sequences moot, as a nice bonus.&lt;/p>
&lt;h3 id="le-fizzbuzz-classique-remedied">Le FizzBuzz Classique, remedied&lt;/h3>
&lt;p>Behold this cleaned up version.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>lazybuzz
[num-xs]
(for [n num-xs]
(&lt;span style="color:#a6e22e">cond&lt;/span>
(zero? (rem n &lt;span style="color:#ae81ff">15&lt;/span>)) &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>
(zero? (rem n &lt;span style="color:#ae81ff">3&lt;/span>)) &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
(zero? (rem n &lt;span style="color:#ae81ff">5&lt;/span>)) &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">:else&lt;/span> n)))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Yes, &lt;code>println&lt;/code> is no more, and&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">user=&amp;gt; (&lt;span style="color:#a6e22e">lazybuzz&lt;/span> (list &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#ae81ff">16&lt;/span>))
(&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">16&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Compare the shape of the collection of nils seen classically, with what we see
now. They are both sequences with the same number of items, &lt;em>but&lt;/em> the new one
contains useful values (insert :trollface: :).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">user=&amp;gt; (&lt;span style="color:#a6e22e">fizz-buzz-classic&lt;/span> (list &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#ae81ff">19&lt;/span>))
&lt;span style="color:#ae81ff">1&lt;/span>
Fizz
Buzz
FizzBuzz
&lt;span style="color:#ae81ff">19&lt;/span>
(&lt;span style="color:#a6e22e">nil&lt;/span> nil nil nil nil) &lt;span style="color:#75715e">; 5 prints, 5 nils&lt;/span>
user=&amp;gt; (&lt;span style="color:#a6e22e">lazybuzz&lt;/span> (list &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#ae81ff">19&lt;/span>))
(&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">19&lt;/span>) &lt;span style="color:#75715e">; no prints, 1 value containing 5 values&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Well, that&amp;rsquo;s because all expressions in Clojure return a value. &lt;code>println&lt;/code>
creates a side effect of printing and has a return value of &lt;code>nil&lt;/code>. Thus for
each item in the input range, the &amp;ldquo;impure&amp;rdquo; classic version prints to the REPL,
collects the return value of each println (nil), and returns that collection.&lt;/p>
&lt;p>The &amp;ldquo;purified&amp;rdquo; fizz-buzz simply calculates a result for each branch and the
&lt;code>for&lt;/code> returns the accumulated result. And now the results are printed inside
parentheses, which is, like, sure whatever. At least it &lt;em>looks&lt;/em> like it&amp;rsquo;s
doing the right calculations &lt;em>and&lt;/em> the pesky nils are gone, so we can move on?&lt;/p>
&lt;p>Not so fast.&lt;/p>
&lt;h3 id="le-fizzbuzz-classique-dissected">Le FizzBuzz Classique, dissected&lt;/h3>
&lt;p>To FizzBuzz creatively in Clojure, we must examine &lt;em>and avoid&lt;/em> the defects of
the classic version, which are as follows.&lt;/p>
&lt;ol>
&lt;li>&lt;strong>Broken behaviour&lt;/strong>: &lt;code>println&lt;/code> alters the state of the world and thus
injects non-determinism into an otherwise purely functional calculation.
This is anathema &lt;sup id="fnref:4">&lt;a href="#fn:4" class="footnote-ref" role="doc-noteref">4&lt;/a>&lt;/sup> to Clojurists (and FP practitioners at large).&lt;/li>
&lt;li>&lt;strong>Broken API contract&lt;/strong>: We get back a useless collection nils, instead of the
result of a calculation that we can use further. We prefer to always write
functions that return useful values.&lt;/li>
&lt;li>&lt;strong>Broken time model&lt;/strong>: Effects want to happen &amp;ldquo;now&amp;rdquo; (here, printing to
some output device), while lazy computations want to happen &amp;ldquo;maybe never&amp;rdquo;
(here, a definition that maps the domain of a collection of countless
numbers to the domain of FizzBuzz). Effects and laziness can be made to
pair well, &lt;em>but only when&lt;/em> we define them separately from the get go, and
have some third way of joining them together safely when needed. For now,
you could do worse than lasering this into your brain: &amp;ldquo;Never mix (side)
effects and laziness.&amp;rdquo;.&lt;/li>
&lt;li>&lt;strong>Broken aesthetic&lt;/strong>: We like our functions to do one job, and do it well.
Printing things is a &lt;em>second&lt;/em> job, and as Messers Hal and Gerry like to
say in SICP &lt;sup id="fnref:5">&lt;a href="#fn:5" class="footnote-ref" role="doc-noteref">5&lt;/a>&lt;/sup>, &amp;ldquo;That&amp;rsquo;s George&amp;rsquo;s problem.&amp;rdquo;.&lt;/li>
&lt;/ol>
&lt;p>Henceforth, all functions shall be pure calculations, and we will rely on
our metaphorical George &amp;ldquo;the REPL&amp;rdquo; Ableman to handle all our print jobs.&lt;/p>
&lt;p>As an added benefit, writing pure functions makes laziness such a good friend,
that we don&amp;rsquo;t even need to acknowledge its presence.&lt;/p>
&lt;p>Yet another benefit is that we won&amp;rsquo;t have to burn hundreds of words to apologise
for broken code &lt;sup id="fnref:6">&lt;a href="#fn:6" class="footnote-ref" role="doc-noteref">6&lt;/a>&lt;/sup>.&lt;/p>
&lt;p>See? Such passion. I wasn&amp;rsquo;t joking when I said &amp;ldquo;looks severely defective to me&amp;rdquo; &lt;sup id="fnref:7">&lt;a href="#fn:7" class="footnote-ref" role="doc-noteref">7&lt;/a>&lt;/sup>.&lt;/p>
&lt;h3 id="le-fizzbuzz-classique-doseq-d">Le FizzBuzz Classique, doseq&amp;rsquo;d&lt;/h3>
&lt;p>Maybe you still aren&amp;rsquo;t convinced. &lt;code>println&lt;/code> is such a global standard. &lt;em>Easy&lt;/em> &lt;sup id="fnref:8">&lt;a href="#fn:8" class="footnote-ref" role="doc-noteref">8&lt;/a>&lt;/sup>.
So you might dig into the standard library more and come up with &lt;code>doseq&lt;/code> to
eliminate laziness&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>doseq-fizz-buzz
[num-xs]
(doseq [n num-xs]
(&lt;span style="color:#a6e22e">cond&lt;/span>
(zero? (rem n &lt;span style="color:#ae81ff">15&lt;/span>)) (println &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>)
(zero? (rem n &lt;span style="color:#ae81ff">3&lt;/span>)) (println &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>)
(zero? (rem n &lt;span style="color:#ae81ff">5&lt;/span>)) (println &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>)
&lt;span style="color:#e6db74">:else&lt;/span> (println n))))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And declare victory&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">user=&amp;gt; (&lt;span style="color:#a6e22e">doseq-fizz-buzz&lt;/span> (list &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#ae81ff">19&lt;/span>))
&lt;span style="color:#ae81ff">1&lt;/span>
Fizz
Buzz
FizzBuzz
&lt;span style="color:#ae81ff">19&lt;/span>
nil &lt;span style="color:#75715e">; maybe we can live with just one nil?&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>But the code is still fatally broken for the other reasons, and now &lt;em>it is
also worse&lt;/em>, because this implementation cannot say &amp;ldquo;here are &lt;em>all&lt;/em> the
fizzbuzzes&amp;rdquo;. Only a lazy definition can say this &lt;em>and&lt;/em> allow you to carry on
computing. Besides, &lt;code>doseq&lt;/code> is meant for cases when we &lt;em>want to cause&lt;/em> side
effects. And the functional Clojurist almost never &lt;em>wants&lt;/em> to.&lt;/p>
&lt;p>Remember the children&amp;rsquo;s game definition of FizzBuzz? It is beautiful because
it &lt;em>does not&lt;/em> say &amp;ldquo;FizzBuzz only for the first K numbers&amp;rdquo;. Now if you go
DuckDuck search the standard coding interview version of the question, what
do you find? &amp;ldquo;Write a program that prints the numbers from 1 to 100
such that&amp;hellip;&amp;rdquo;.&lt;/p>
&lt;p>Boo.&lt;/p>
&lt;h3 id="le-fizzbuzz-classique-doall-d">Le FizzBuzz Classique, doall&amp;rsquo;d&lt;/h3>
&lt;p>As a famous TV detective would say; &amp;ldquo;Oh, just one other thing.&amp;rdquo;. Here are ways
to break your programs. And if you are feeling suitably adventurous, to also
test the stability of your employment.&lt;/p>
&lt;p>The following invocation of &lt;code>lazybuzz&lt;/code> in your &lt;code>-main&lt;/code> would not be fine,
assuming you wanted to do something useful with it. But would also not
precipitate anything terrible.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>-main
&lt;span style="color:#e6db74">&amp;#34;The entry point to your microservice.&amp;#34;&lt;/span>
[&lt;span style="color:#f92672">&amp;amp;&lt;/span> args]
&lt;span style="color:#75715e">;; Do things ...&lt;/span>
(println &lt;span style="color:#e6db74">&amp;#34;I&amp;#39;m about to do...&amp;#34;&lt;/span>)
&lt;span style="color:#75715e">;; No block, no foul.&lt;/span>
(&lt;span style="color:#a6e22e">lazybuzz&lt;/span> (&lt;span style="color:#a6e22e">range&lt;/span>))
&lt;span style="color:#75715e">;; Sure, why not ...&lt;/span>
(println &lt;span style="color:#e6db74">&amp;#34;I&amp;#39;m done!&amp;#34;&lt;/span>))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Here is a good way to break your software &lt;!-- raw HTML omitted -->and&lt;!-- raw HTML omitted --> print FizzBuzzes to the console
indefinitely (or at least as long as your computer can make new numbers).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>-main
&lt;span style="color:#e6db74">&amp;#34;The entry point to your microservice.&amp;#34;&lt;/span>
[&lt;span style="color:#f92672">&amp;amp;&lt;/span> args]
&lt;span style="color:#75715e">;; Do things ...&lt;/span>
(println &lt;span style="color:#e6db74">&amp;#34;I&amp;#39;m about to do...&amp;#34;&lt;/span>)
&lt;span style="color:#75715e">;; Spin wheels until the numbers run out.&lt;/span>
(&lt;span style="color:#a6e22e">doseq-fizz-buzz&lt;/span> (&lt;span style="color:#a6e22e">range&lt;/span>))
&lt;span style="color:#75715e">;; Maybe never ...&lt;/span>
(println &lt;span style="color:#e6db74">&amp;#34;I&amp;#39;m done!&amp;#34;&lt;/span>))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>As a funner party trick, if you make a computer (VM) with a bad output device
(or redirect program output to /dev/full), then you can crash or hang your
program. If you discover it crashes, feel free to daemonise it and make an
infinitely restarting JVM process that does nothing but burn CPU cycles.
Take that, cryptominers!&lt;/p>
&lt;p>To be fair, you can also break programs with lazy evaluation, with the added
benefit of doing it silently. But at least you are forced to say &lt;code>doall&lt;/code>,
which might make you feel at least a tiny bit guilty.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>-main
&lt;span style="color:#e6db74">&amp;#34;The entry point to your microservice.&amp;#34;&lt;/span>
[&lt;span style="color:#f92672">&amp;amp;&lt;/span> args]
&lt;span style="color:#75715e">;; Do things...&lt;/span>
(println &lt;span style="color:#e6db74">&amp;#34;I&amp;#39;m about to do...&amp;#34;&lt;/span>)
&lt;span style="color:#75715e">;; Spin wheels silently, until OOM or no more numbers,&lt;/span>
&lt;span style="color:#75715e">;; whichever happens first.&lt;/span>
(doall (&lt;span style="color:#a6e22e">lazybuzz&lt;/span> (&lt;span style="color:#a6e22e">range&lt;/span>)))
&lt;span style="color:#75715e">;; Maybe not ...&lt;/span>
(println &lt;span style="color:#e6db74">&amp;#34;I&amp;#39;m done!&amp;#34;&lt;/span>))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>To see if you can get &lt;em>fired&lt;/em> by solving fizzbuzz (now that&amp;rsquo;s a concept,
innit?), you can ship to production &lt;sup id="fnref:9">&lt;a href="#fn:9" class="footnote-ref" role="doc-noteref">9&lt;/a>&lt;/sup> the&amp;hellip;&lt;/p>
&lt;ul>
&lt;li>doseq version, to fill up your log files with fizzbuzz. They will fill
up really fast. Faster than logrotate.&lt;/li>
&lt;li>doall lazybuzz version, to confuse the daylights out of everyone, at
least until your process dies with OOM.&lt;/li>
&lt;li>badly daemonised verison, to enjoy repeated restart cycles through crashes
from number overflows and/or OOMs.&lt;/li>
&lt;li>Or something actually dangerous&amp;hellip;&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>-main
&lt;span style="color:#e6db74">&amp;#34;The entry point to your microservice.&amp;#34;&lt;/span>
[&lt;span style="color:#f92672">&amp;amp;&lt;/span> args]
&lt;span style="color:#75715e">;; Do things...&lt;/span>
(println &lt;span style="color:#e6db74">&amp;#34;I&amp;#39;m about to do...&amp;#34;&lt;/span>)
&lt;span style="color:#75715e">;; Your /thought/ you were going to /do/ something useful here.&lt;/span>
(&lt;span style="color:#a6e22e">fizz-buzz-classic&lt;/span> (&lt;span style="color:#a6e22e">range&lt;/span>))
&lt;span style="color:#75715e">;; You now falsely believe you did something useful ...&lt;/span>
(println &lt;span style="color:#e6db74">&amp;#34;I&amp;#39;m done!&amp;#34;&lt;/span>))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I assure you, experienced Clojurists are no longer grinning at the tomfoolery.
Many of us have shipped &lt;sup id="fnref:10">&lt;a href="#fn:10" class="footnote-ref" role="doc-noteref">10&lt;/a>&lt;/sup> (or &lt;em>almost&lt;/em> shipped) this category of
bugs to prod. Not fun.&lt;/p>
&lt;p>OK, now I consider &lt;em>Le Cheval Classique&lt;/em> suitably flogged postmortem, and
yourself suitably &lt;em>Caveat Emptor&lt;/em>-ed.&lt;/p>
&lt;p>Now we will FizzBuzz joyously.&lt;/p>
&lt;h2 id="little-functions-are-good">Little functions are good!&lt;/h2>
&lt;p>Once we remove the &lt;em>ick&lt;/em> of &lt;code>println&lt;/code> from our code, we can see further room
for improvement. &lt;code>(zero? (rem n divisor))&lt;/code> is not only a common pattern,
it is actually a distinct &lt;em>idea&lt;/em>, viz. &amp;ldquo;Is &lt;code>n&lt;/code> &lt;em>divisible&lt;/em> by &lt;code>divisor&lt;/code>?&amp;rdquo;.&lt;/p>
&lt;p>We can name it locally, with &lt;code>let&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>letbuzz
[num-xs]
(for [n num-xs]
(&lt;span style="color:#66d9ef">let &lt;/span>[divisible? (&lt;span style="color:#66d9ef">fn &lt;/span>[n1 n2] (zero? (rem n1 n2)))] &lt;span style="color:#75715e">; locally-bound lambda&lt;/span>
(&lt;span style="color:#a6e22e">cond&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">15&lt;/span>) &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">3&lt;/span>) &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">5&lt;/span>) &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">:else&lt;/span> n))))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;em>However&lt;/em>, this definition of divisibility is generally applicable to numbers,
so it makes sense to define a top-level global concept.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">def &lt;/span>divisible?
&lt;span style="color:#e6db74">&amp;#34;True when the remainder of n1/n2 is zero. e.g. (divisible? 4 2) =&amp;gt; true&amp;#34;&lt;/span>
(&lt;span style="color:#66d9ef">fn &lt;/span>[n1 n2] (zero? (rem n1 n2))))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Yep, &lt;code>defn&lt;/code> is just &lt;code>def&lt;/code> + &lt;code>fn&lt;/code> under the hood, and we can conveniently
write the same thing as follows.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>divisible?
&lt;span style="color:#e6db74">&amp;#34;True when the remainder of n1/n2 is zero. e.g. (divisible? 4 2) =&amp;gt; true&amp;#34;&lt;/span>
[n1 n2]
(zero? (rem n1 n2)))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>We can also use &lt;code>comp&lt;/code> to define divisibility more succinctly.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">def &lt;/span>divisible?
&lt;span style="color:#e6db74">&amp;#34;True when the remainder of n1/n2 is zero. e.g. (divisible? 4 2) =&amp;gt; true&amp;#34;&lt;/span>
(comp zero? rem))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Since the various implementations of &lt;code>divisible?&lt;/code> are all pure functions,
they are drop-in replacements for each other (&amp;ldquo;referentially transparent&amp;rdquo;).
Use whichever version you like best.&lt;/p>
&lt;p>It may seem silly to write such tiny functions, but we earn a lot of firepower
by lifting out named domain concepts, &lt;em>especially&lt;/em> the simple ones, because
we can &lt;em>compose&lt;/em> them flexibly to express other domain concepts as needed.&lt;/p>
&lt;h2 id="map-reduce-for-fizzbuzz">map reduce for FizzBuzz&lt;/h2>
&lt;p>Here&amp;rsquo;s a doozy. By putting FizzBuzz &lt;em>logic&lt;/em> inside &lt;code>for&lt;/code>, we have in fact
deeply intertwined &lt;sup id="fnref:11">&lt;a href="#fn:11" class="footnote-ref" role="doc-noteref">11&lt;/a>&lt;/sup> two very distinct computations; viz. sequence
generation, and choice-making.&lt;/p>
&lt;p>Suppose we lifted out the decision logic into its own function?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>basic-buzz
&lt;span style="color:#e6db74">&amp;#34;We can also trivially rewrite this with &amp;#39;condp&amp;#39;.
&lt;/span>&lt;span style="color:#e6db74"> ref: https://clojuredocs.org/clojure.core/condp&amp;#34;&lt;/span>
[n]
(&lt;span style="color:#a6e22e">cond&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">15&lt;/span>) &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">3&lt;/span>) &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">5&lt;/span>) &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">:else&lt;/span> n))
(&lt;span style="color:#a6e22e">comment&lt;/span>
&lt;span style="color:#75715e">;; Unsurprisingly...&lt;/span>
(&lt;span style="color:#a6e22e">basic-buzz&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>) =&amp;gt; &lt;span style="color:#ae81ff">1&lt;/span>
(&lt;span style="color:#a6e22e">basic-buzz&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span>) =&amp;gt; &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
(&lt;span style="color:#a6e22e">basic-buzz&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>) =&amp;gt; &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>
(&lt;span style="color:#a6e22e">basic-buzz&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>) =&amp;gt; &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>
)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now we can bring back &lt;code>for&lt;/code> this way&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">def &lt;/span>all-fizz-buzzes
(for [n (rest (&lt;span style="color:#a6e22e">range&lt;/span>))]
(&lt;span style="color:#a6e22e">basic-buzz&lt;/span> n)))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>But our new choice opens up the design space, because we can directly say
&amp;ldquo;this is just a mapping of the domain of numbers to the domain of FizzBuzz&amp;rdquo;.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">def &lt;/span>all-fizz-buzzes
(map basic-buzz (rest (&lt;span style="color:#a6e22e">range&lt;/span>))))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now since &lt;code>map&lt;/code> is conceptually just a special case of &lt;code>reduce&lt;/code>, we could write
the following. &lt;em>However&lt;/em> in Clojure, &lt;code>map&lt;/code> is lazy but &lt;code>reduce&lt;/code> is eager, and
we only use &lt;em>reduce&lt;/em> when we want to force a final calculation.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">def &lt;/span>just-some-fizz-buzzes
(reduce (&lt;span style="color:#66d9ef">fn &lt;/span>[result n]
(conj result
(&lt;span style="color:#a6e22e">basic-buzz&lt;/span> n)))
[]
&lt;span style="color:#75715e">;; the classic programmer&amp;#39;s problem statement&lt;/span>
(range &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">101&lt;/span>)))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Once again, we earned more compositional power by lifting out another small
concept. Let&amp;rsquo;s do some more of that.&lt;/p>
&lt;h2 id="domain-driven-design-fizzbuzz">Domain Driven Design FizzBuzz&lt;/h2>
&lt;p>We can further define concepts specific to the business domain of FizzBuzz.
This opens up our design space even more.&lt;/p>
&lt;p>Before that I&amp;rsquo;ll make one small tweak to help us express ourselves better.
I&amp;rsquo;ll rearrange the argument list of &lt;code>divisible?&lt;/code> so that the &amp;ldquo;more constant&amp;rdquo;
argument is placed first, and successively more variable argument(s) are
placed successively. Also rely on &amp;ldquo;truthiness&amp;rdquo; in Clojure to imply yes/no.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>divisible?
&lt;span style="color:#e6db74">&amp;#34;Given a number &amp;#39;n&amp;#39;, return the given word (truthy) when it is divisible
&lt;/span>&lt;span style="color:#e6db74"> by the divisor, or nil otherwise (falsey).&amp;#34;&lt;/span>
[divisor the-word n]
(when (zero? (rem n divisor))
the-word))
(&lt;span style="color:#66d9ef">def &lt;/span>fizzes?
&lt;span style="color:#e6db74">&amp;#34;Is a given number divisible by 3?&amp;#34;&lt;/span>
(partial divisible? &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>))
(&lt;span style="color:#66d9ef">def &lt;/span>buzzes?
&lt;span style="color:#e6db74">&amp;#34;Is a given number divisible by 5?&amp;#34;&lt;/span>
(partial divisible? &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>))
(&lt;span style="color:#66d9ef">def &lt;/span>fizzbuzzes?
&lt;span style="color:#e6db74">&amp;#34;Is a given number divisible by 3 and 5?&amp;#34;&lt;/span>
(partial divisible? &lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now we can rewrite &lt;code>basic-buzz&lt;/code> using &lt;code>or&lt;/code>, which short-circuits, and
returns the first &lt;em>truthy&lt;/em> value it encounters. You will see this construct
in real-world Clojure code.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>or-buzz
&lt;span style="color:#e6db74">&amp;#34;Just like conditional matching, but exploit short-circuit behaviour of &amp;#39;or&amp;#39;.
&lt;/span>&lt;span style="color:#e6db74"> Sadly, order of conditionals still matters.&amp;#34;&lt;/span>
[n]
(or (&lt;span style="color:#a6e22e">fizzbuzzes?&lt;/span> n)
(&lt;span style="color:#a6e22e">buzzes?&lt;/span> n)
(&lt;span style="color:#a6e22e">fizzes?&lt;/span> n)
n))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>We argued that we are essentially expressing a choice, and that we can even
do it with &lt;code>juxt&lt;/code>, because once we grok &lt;code>juxt&lt;/code>, we want to use it &lt;em>everywhere&lt;/em>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>juxt-buzz
&lt;span style="color:#e6db74">&amp;#34;juxt for fun:
&lt;/span>&lt;span style="color:#e6db74"> e.g. ((juxt f g h) 42) -&amp;gt; [(f 42) (g 42) (h 42)]
&lt;/span>&lt;span style="color:#e6db74"> cf. https://clojuredocs.org/clojure.core/juxt
&lt;/span>&lt;span style="color:#e6db74"> Sadly, order of conditional checks still matters, which combined with
&lt;/span>&lt;span style="color:#e6db74"> the nil-punning that&amp;#39;s going on here is too subtle for production use.&amp;#34;&lt;/span>
[n]
(some identity ((&lt;span style="color:#a6e22e">juxt&lt;/span> fizzbuzzes? buzzes? fizzes? identity)
n)))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Yeah, that&amp;rsquo;s a head-scratcher. Best leave it back at home.&lt;/p>
&lt;h2 id="actually-domain-driven-fizzbuzz">Actually Domain Driven FizzBuzz&lt;/h2>
&lt;p>You might protest that well actually the clever little functions, in fact,
express the domain of the &lt;em>solution&lt;/em> (the business of calculating FizzBuzz),
not the domain of the &lt;em>problem&lt;/em> (arithmetic representation of FizzBuzz).&lt;/p>
&lt;p>And even though I flunked maths a lot, I would concur. So here goes nothing&amp;hellip;&lt;/p>
&lt;p>15 is the least common multiple of the prime factors. Suppose we cook up an
encoding scheme based on remainders of 15, and write it down as a lookup table?
We can then find &lt;code>(rem n 15)&lt;/code>, and look up the answer to FizzBuzz in the table.&lt;/p>
&lt;p>Why do a lookup table? Well, what is the simplest possible function? A literal
hard-coded lookup table!&lt;/p>
&lt;p>In Clojure, we can use hash-maps to write down look-up tables.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">&lt;span style="color:#75715e">;; A table of remainders of 15, in a hash-map.&lt;/span>
{&lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">6&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">9&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">12&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">10&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And here is a very fun and useful fact. Clojure hash-maps are not just inert
data. They also behave as functions of their keys. We can literally call
&lt;code>({:a 42} :a)&lt;/code> and get back 42. Noice!&lt;/p>
&lt;p>So suppose we define a global lookup table?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">def &lt;/span>rem15-&amp;gt;fizz-buzz
{&lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">6&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">9&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">12&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">10&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>})
(&lt;span style="color:#a6e22e">comment&lt;/span>
(&lt;span style="color:#a6e22e">rem15-&amp;gt;fizz-buzz&lt;/span> (rem &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>)) =&amp;gt; &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
(&lt;span style="color:#a6e22e">rem15-&amp;gt;fizz-buzz&lt;/span> (rem &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>)) =&amp;gt; &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>
(&lt;span style="color:#a6e22e">rem15-&amp;gt;fizz-buzz&lt;/span> (rem &lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>)) =&amp;gt; &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>
(&lt;span style="color:#a6e22e">rem15-&amp;gt;fizz-buzz&lt;/span> (rem &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>)) =&amp;gt; nil
)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>See the &lt;code>nil&lt;/code> returned for &amp;ldquo;no result found&amp;rdquo;? If you were paying attention
to the nil punning &lt;sup id="fnref:12">&lt;a href="#fn:12" class="footnote-ref" role="doc-noteref">12&lt;/a>&lt;/sup>, and the short-circuiting &lt;code>or&lt;/code>, you might get
the following idea. And you would not be wrong.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>or-rem15-buzz
[n]
(or (&lt;span style="color:#a6e22e">rem15-&amp;gt;fizz-buzz&lt;/span> (rem n &lt;span style="color:#ae81ff">15&lt;/span>))
n))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>But we can be more right by using the &lt;code>get&lt;/code> function, which is designed for
use with hash-maps, and which allows us to conveniently specify a fallback
value for the &amp;ldquo;not found&amp;rdquo; case.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>get-rem15-buzz
[n]
(get rem15-&amp;gt;fizz-buzz
(rem n &lt;span style="color:#ae81ff">15&lt;/span>)
n))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Not to press the point, but they are referentially transparent.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(= (map or-rem15-buzz (range &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">16&lt;/span>))
(map get-rem15-buzz (range &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">16&lt;/span>)))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>You may have also astutely noted that, in both the implementations above,
the order of calculation ceases to matter. Now we are doing maths.&lt;/p>
&lt;h2 id="fizzbuzz-by-construction">FizzBuzz by construction&lt;/h2>
&lt;p>Closely related to remainder lookup tables, we can make the observation that
FizzBuzz is cyclical in modulo 3, 5, and 15. So we can directly define the
&lt;em>idea&lt;/em> of FizzBuzz in those terms.&lt;/p>
&lt;p>This FizzBuzz is correctly ordered &lt;em>by definition&lt;/em>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">def &lt;/span>mod-cycle-buzz
&lt;span style="color:#e6db74">&amp;#34;We can declare a lazy sequence of FizzBuzz as modulo 3, 5, 15.
&lt;/span>&lt;span style="color:#e6db74"> The sequence is ordered by definition.&amp;#34;&lt;/span>
(&lt;span style="color:#66d9ef">let &lt;/span>[n identity
f (constantly &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>)
b (constantly &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>)
fb (constantly &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>)]
(cycle [n n f
n b f
n n f
b n f
n n fb])))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now, Clojure&amp;rsquo;s &lt;code>map&lt;/code> is not only lazy, it can also apply a function of &lt;code>n&lt;/code>
arguments over &lt;code>n&lt;/code> collections until any one of the collections is exhausted.
So we can&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">def &lt;/span>all-fizz-buzzes
(map (&lt;span style="color:#66d9ef">fn &lt;/span>[f n] (&lt;span style="color:#a6e22e">f&lt;/span> n))
mod-cycle-buzz &lt;span style="color:#75715e">; countless modulo pattern&lt;/span>
(rest (&lt;span style="color:#a6e22e">range&lt;/span>)))) &lt;span style="color:#75715e">; countless sequence of numbers&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>If we think in terms of the prime factors 3 and 5, along with modulo cycles,
it may inspire a generalised version of fizzbuzz, like so.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>any-mod-cycle-buzz
&lt;span style="color:#e6db74">&amp;#34;Given a number and a sequence of words mapping to prime factors,
&lt;/span>&lt;span style="color:#e6db74"> either return the corresponding word-version for the number position,
&lt;/span>&lt;span style="color:#e6db74"> or the number itself, if no prime factor exists.
&lt;/span>&lt;span style="color:#e6db74">
&lt;/span>&lt;span style="color:#e6db74"> Basically, the set of words should map to set of prime factors.
&lt;/span>&lt;span style="color:#e6db74">
&lt;/span>&lt;span style="color:#e6db74"> We also don&amp;#39;t make any assumptions about order of words here. It is up
&lt;/span>&lt;span style="color:#e6db74"> to the caller to choose whatever sequence they please.&amp;#34;&lt;/span>
[num &lt;span style="color:#f92672">&amp;amp;&lt;/span> words]
(or (&lt;span style="color:#a6e22e">not-empty&lt;/span> (reduce str words))
num))
(map any-mod-cycle-buzz
(range &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">16&lt;/span>)
(cycle [nil nil &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>])
(cycle [nil nil nil nil &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>]))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And last but not least, this interpretation allows us to express the arithmetic
&lt;em>identity&lt;/em> of the whole category of FizzBuzzes, which is, just the number
sequence itself. (As in, the identity of + is 0 and that of * is 1).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(map any-mod-cycle-buzz
(range &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">16&lt;/span>))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>But then again, I&amp;rsquo;ve flunked maths too often to be confident about any of this.
Please complain to me if I&amp;rsquo;m wrong.&lt;/p>
&lt;h2 id="interlude-all-the-fizz-buzzes-so-far">Interlude: all the fizz-buzzes so far&lt;/h2>
&lt;p>I&amp;rsquo;ll drop this mini &lt;em>pièce de résistance&lt;/em> (for now), and pause for a breather.
I&amp;rsquo;ve copied down all the fizz-buzz variants (minus doc strings for brevity).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">ns &lt;/span>all.them.fizz.buzzers)
(&lt;span style="color:#66d9ef">def &lt;/span>fizz-buzz map) &lt;span style="color:#75715e">; now, what `map` can do fizz-buzz can too&lt;/span>
&lt;span style="color:#75715e">;; Le FizzBuzz Classique Functional&lt;/span>
(&lt;span style="color:#66d9ef">defn &lt;/span>basic-buzz
[n]
(&lt;span style="color:#66d9ef">let &lt;/span>[divisible? (comp zero? rem)]
(&lt;span style="color:#a6e22e">cond&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">15&lt;/span>) &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">5&lt;/span>) &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">3&lt;/span>) &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">:else&lt;/span> n)))
&lt;span style="color:#75715e">;; Branching logic FizzBuzzes&lt;/span>
(&lt;span style="color:#66d9ef">defn &lt;/span>divisible?
[divisor the-word n]
(when (zero? (rem n divisor))
the-word))
(&lt;span style="color:#66d9ef">def &lt;/span>fizzes? (partial divisible? &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>))
(&lt;span style="color:#66d9ef">def &lt;/span>buzzes? (partial divisible? &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>))
(&lt;span style="color:#66d9ef">def &lt;/span>fizzbuzzes? (partial divisible? &lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>))
(&lt;span style="color:#66d9ef">defn &lt;/span>or-buzz
[n]
(or (&lt;span style="color:#a6e22e">fizzbuzzes?&lt;/span> n)
(&lt;span style="color:#a6e22e">buzzes?&lt;/span> n)
(&lt;span style="color:#a6e22e">fizzes?&lt;/span> n)
n))
(&lt;span style="color:#66d9ef">defn &lt;/span>juxt-buzz
[n]
(some identity
((&lt;span style="color:#a6e22e">juxt&lt;/span> fizzbuzzes? buzzes? fizzes? identity)
n)))
&lt;span style="color:#75715e">;; More mathematical FizzBuzzes&lt;/span>
(&lt;span style="color:#66d9ef">def &lt;/span>rem15-&amp;gt;fizz-buzz
{&lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">6&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">9&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">12&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">10&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>})
(&lt;span style="color:#66d9ef">defn &lt;/span>or-rem15-buzz
[n]
(or (&lt;span style="color:#a6e22e">rem15-&amp;gt;fizz-buzz&lt;/span> (rem n &lt;span style="color:#ae81ff">15&lt;/span>))
n))
(&lt;span style="color:#66d9ef">defn &lt;/span>get-rem15-buzz
[n]
(get rem15-&amp;gt;fizz-buzz
(rem n &lt;span style="color:#ae81ff">15&lt;/span>)
n))
(&lt;span style="color:#66d9ef">def &lt;/span>mod-cycle-buzz
(&lt;span style="color:#66d9ef">let &lt;/span>[n identity
f (constantly &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>)
b (constantly &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>)
fb (constantly &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>)]
(cycle [n n f
n b f
n n f
b n f
n n fb])))
(&lt;span style="color:#66d9ef">defn &lt;/span>any-mod-cycle-buzz
[num &lt;span style="color:#f92672">&amp;amp;&lt;/span> words]
(or (&lt;span style="color:#a6e22e">not-empty&lt;/span> (reduce str words))
num))
&lt;span style="color:#75715e">;; Inspect and check the fizz-buzzes&lt;/span>
(&lt;span style="color:#66d9ef">defn &lt;/span>call-all-fizz-buzzers
[range-of-buzzees]
[(&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> basic-buzz
range-of-buzzees)
(&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> or-buzz
range-of-buzzees)
(&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> juxt-buzz
range-of-buzzees)
(&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> or-rem15-buzz
range-of-buzzees)
(&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> get-rem15-buzz
range-of-buzzees)
(&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> (&lt;span style="color:#66d9ef">fn &lt;/span>[f n] (&lt;span style="color:#a6e22e">f&lt;/span> n))
mod-cycle-buzz
range-of-buzzees)
(&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> any-mod-cycle-buzz
range-of-buzzees
(cycle [nil nil &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>])
(cycle [nil nil nil nil &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>]))])
(&lt;span style="color:#66d9ef">defn &lt;/span>check-all-fizz-buzzers
&lt;span style="color:#e6db74">&amp;#34;Return true if all known fizz-buzzers produce equal results
&lt;/span>&lt;span style="color:#e6db74"> for the programmer&amp;#39;s FizzBuzz for numbers 1 to 100&amp;#34;&lt;/span>
[]
(apply = (&lt;span style="color:#a6e22e">call-all-fizz-buzzers&lt;/span> (range &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">101&lt;/span>))))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And lest we forget, let us flog the dead horse one last time.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">defn &lt;/span>severely-broken-buzz
&lt;span style="color:#e6db74">&amp;#34;Please don&amp;#39;t do this in Clojure.&amp;#34;&lt;/span>
[n]
(&lt;span style="color:#a6e22e">cond&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">15&lt;/span>) (println &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>)
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">3&lt;/span>) (println &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>)
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">5&lt;/span>) (println &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>)
&lt;span style="color:#e6db74">:else&lt;/span> (println n)))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The mind is abuzz drafting moaaaar variants&amp;hellip; Stay tuned!&lt;/p>
&lt;h2 id="peano-fizzbuzz">Peano FizzBuzz&lt;/h2>
&lt;p>Since we are computing with natural numbers, we can express FizzBuzz in terms
of the &amp;ldquo;Successor&amp;rdquo; operation of Peano arithmetic.&lt;/p>
&lt;p>However, we have to modify our number system a bit to make it work right.
We define a PeanoBuzz number to be a pair of a natural number and its FizzBuzz
counterpart. The &lt;em>PeanoBuzz&lt;/em> number system starts at &lt;code>[0 0]&lt;/code>.&lt;/p>
&lt;p>We can enjoy the fruits of compositionality that we planted earlier.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">ns &lt;/span>all.them.fizz.buzzers)
(&lt;span style="color:#66d9ef">def &lt;/span>rem15-&amp;gt;fizz-buzz
{&lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">6&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">9&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">12&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>
&lt;span style="color:#ae81ff">10&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>})
(&lt;span style="color:#66d9ef">defn &lt;/span>get-rem15-buzz
[n]
(get rem15-&amp;gt;fizz-buzz
(rem n &lt;span style="color:#ae81ff">15&lt;/span>)
n))
(&lt;span style="color:#66d9ef">def &lt;/span>S
&lt;span style="color:#e6db74">&amp;#34;The PeanoBuzz number system starting at [0 0] is closed under
&lt;/span>&lt;span style="color:#e6db74"> this definition of Successor.&amp;#34;&lt;/span>
(comp (&lt;span style="color:#a6e22e">juxt&lt;/span> identity get-rem15-buzz)
inc
first))
(&lt;span style="color:#66d9ef">def &lt;/span>all-peano-buzzes
(iterate S [&lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>]))
(&lt;span style="color:#a6e22e">comment&lt;/span>
(= (take &lt;span style="color:#ae81ff">16&lt;/span> all-peano-buzzes)
[[&lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>] [&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>] [&lt;span style="color:#ae81ff">2&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>]
[&lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>] [&lt;span style="color:#ae81ff">4&lt;/span> &lt;span style="color:#ae81ff">4&lt;/span>]
[&lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>]
[&lt;span style="color:#ae81ff">6&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>] [&lt;span style="color:#ae81ff">7&lt;/span> &lt;span style="color:#ae81ff">7&lt;/span>] [&lt;span style="color:#ae81ff">8&lt;/span> &lt;span style="color:#ae81ff">8&lt;/span>]
[&lt;span style="color:#ae81ff">9&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>]
[&lt;span style="color:#ae81ff">10&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>] [&lt;span style="color:#ae81ff">11&lt;/span> &lt;span style="color:#ae81ff">11&lt;/span>]
[&lt;span style="color:#ae81ff">12&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>] [&lt;span style="color:#ae81ff">13&lt;/span> &lt;span style="color:#ae81ff">13&lt;/span>] [&lt;span style="color:#ae81ff">14&lt;/span> &lt;span style="color:#ae81ff">14&lt;/span>]
[&lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>]]))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Since we have a &lt;code>S&lt;/code> that closes over the &lt;em>PeanoBuzz&lt;/em> number system, I wonder
if we can satisfy all the &lt;a href="https://en.wikipedia.org/wiki/Peano%5Faxioms">Peano Axioms&lt;/a>? Probably another blog post :)&lt;/p>
&lt;p>Incidentally, we can trivially map the domain of PeanoBuzz back into the
domain of FizzBuzz.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">ns &lt;/span>all.them.fizz.buzzers)
(= (&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> basic-buzz
(range &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">101&lt;/span>))
(&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> second
(take &lt;span style="color:#ae81ff">100&lt;/span> (rest all-peano-buzzes))))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>We are already half way to Lambda Calculus / Church Numerals. But going there
will side-track our FizzBuzz expedition way too much. So I&amp;rsquo;ll leave the Church
Numerals version as an exercise to the reader &lt;sup id="fnref:13">&lt;a href="#fn:13" class="footnote-ref" role="doc-noteref">13&lt;/a>&lt;/sup>. Try to make it
so that that we can define an &lt;code>all-church-nums-buzz&lt;/code> and slot it into the
&lt;code>fizz-buzz&lt;/code> checks we already have.&lt;/p>
&lt;h2 id="dispatch-buzz">Dispatch Buzz&lt;/h2>
&lt;p>If you squint at the conditional FizzBuzzes, like &lt;code>basic-buzz&lt;/code>, &lt;code>or-buzz&lt;/code> etc.,
you might re-see them as a &lt;em>dispatch&lt;/em> problem. And why would you be wrong?
They, like any other if-else-y construct are truth tables hard-wired to
&amp;ldquo;finalised&amp;rdquo; values or operations.&lt;/p>
&lt;p>Naturally we will follow the consummate Clojurian&amp;rsquo;s primal instinct of needing
to pry apart two things masquerading as one (&lt;em>&amp;ldquo;decomplecting&amp;rdquo;&lt;/em> &lt;sup id="fnref:14">&lt;a href="#fn:14" class="footnote-ref" role="doc-noteref">14&lt;/a>&lt;/sup>
in Clojurish). But, &lt;em>what exactly&lt;/em> are we, ah, &lt;em>decomplecting&lt;/em>? Now that is
a very interesting rabbit hole.&lt;/p>
&lt;p>In this case we are &lt;em>&amp;ldquo;separating mechanism from policy&amp;rdquo;&lt;/em> &lt;sup id="fnref:15">&lt;a href="#fn:15" class="footnote-ref" role="doc-noteref">15&lt;/a>&lt;/sup>.
Figuring out how to do this delivers a powerful, flexible method of program
design into our eager hands.&lt;/p>
&lt;p>This table shows &amp;ldquo;mechanism&amp;rdquo; and &amp;ldquo;policy&amp;rdquo; hard-wired together.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-org" data-lang="org">&amp;lt;&lt;span style="color:#e6db74">-- ------- MECHANISM -------- --&lt;/span>&amp;gt;|&amp;lt;&lt;span style="color:#e6db74">-- POLICY --&lt;/span>&amp;gt;
&lt;span style="color:#e6db74">| n divisible? 3 | n divisible? 5 | Final value |&lt;/span>
&lt;span style="color:#e6db74">|----------------+----------------+-------------|&lt;/span>
&lt;span style="color:#e6db74">| true | true | FizzBuzz |&lt;/span>
&lt;span style="color:#e6db74">| true | false | Fizz |&lt;/span>
&lt;span style="color:#e6db74">| false | true | Buzz |&lt;/span>
&lt;span style="color:#e6db74">| false | false | n |&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Here is an attempt to pry the two apart.&lt;/p>
&lt;p>&lt;em>&lt;strong>Mechanism&lt;/strong>&lt;/em>&lt;/p>
&lt;p>The &lt;em>&lt;strong>&amp;ldquo;mechanism&amp;rdquo;&lt;/strong>&lt;/em> here is &lt;em>any&lt;/em> function that translates a number (or more
generally, &lt;em>any&lt;/em> thing) to the two inputs of a 2-value truth table. We can
see it more clearly if we rewrite the input columns of the truth table like
this. Here &lt;code>f&lt;/code> and &lt;code>g&lt;/code> are functions of &lt;code>a&lt;/code> to Boolean.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-org" data-lang="org">&lt;span style="color:#e6db74">| (f a) | (g a) |&lt;/span>
&lt;span style="color:#e6db74">|-------+-------|&lt;/span>
&lt;span style="color:#e6db74">| true | true |&lt;/span>
&lt;span style="color:#e6db74">| true | false |&lt;/span>
&lt;span style="color:#e6db74">| false | true |&lt;/span>
&lt;span style="color:#e6db74">| false | false |&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>We can express this as a Clojure punction &amp;lsquo;coz (f a) (g a) is ((juxt f g) a).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">ns &lt;/span>dispatch.buzz)
(&lt;span style="color:#66d9ef">defn &lt;/span>mechanism
&lt;span style="color:#e6db74">&amp;#34;Given two functions, presumably of anything -to-&amp;gt; Boolean, return
&lt;/span>&lt;span style="color:#e6db74"> a function that can construct inputs of a 2-input truth table.&amp;#34;&lt;/span>
[f? g?]
(&lt;span style="color:#a6e22e">juxt&lt;/span> f? g?))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>See? Such abstract. Much general-purpose. Very decomplect. Wow.&lt;/p>
&lt;p>&lt;em>&lt;strong>Policy&lt;/strong>&lt;/em>&lt;/p>
&lt;p>Here, we define &lt;em>&lt;strong>&amp;ldquo;policy&amp;rdquo;&lt;/strong>&lt;/em> as something having special context of FizzBuzz
that consumes input rows of the truth table and emits corresponding output fields.&lt;/p>
&lt;p>First, we specialise the abstract &lt;code>mechanism&lt;/code> to a FizzBuzz mechanism. You
may smirk &lt;sup id="fnref:16">&lt;a href="#fn:16" class="footnote-ref" role="doc-noteref">16&lt;/a>&lt;/sup>, but just you wait. There is a (multi) method to the
madness&amp;hellip;&lt;/p>
&lt;p>Here is the table we started with, rewritten for our specialisation.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-org" data-lang="org">&lt;span style="color:#e6db74">| (fizzes? n) | (buzzes? n) | (mechanism fizzes? buzzes?) -&amp;gt; mfb |&lt;/span>
&lt;span style="color:#e6db74">|-------------+-------------+------------------------------------|&lt;/span>
&lt;span style="color:#e6db74">| true | true | (mfb n) =&amp;gt; &amp;#34;FizzBuzz&amp;#34; |&lt;/span>
&lt;span style="color:#e6db74">| true | false | (mfb n) =&amp;gt; &amp;#34;Fizz&amp;#34; |&lt;/span>
&lt;span style="color:#e6db74">| false | true | (mfb n) =&amp;gt; &amp;#34;Buzz&amp;#34; |&lt;/span>
&lt;span style="color:#e6db74">| false | false | (mfb n) =&amp;gt; n |&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Here is the intermediate step of the specialisation, viz. &lt;code>(mechanism f g) -&amp;gt; h&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">ns &lt;/span>dispatch.buzz)
(&lt;span style="color:#66d9ef">defn &lt;/span>divisible?
[divisor n]
(zero? (rem n divisor)))
(&lt;span style="color:#66d9ef">def &lt;/span>fizzes? (partial divisible? &lt;span style="color:#ae81ff">3&lt;/span>))
(&lt;span style="color:#66d9ef">def &lt;/span>buzzes? (partial divisible? &lt;span style="color:#ae81ff">5&lt;/span>))
&lt;span style="color:#75715e">;; If we take the abstract mechanism and give it functions&lt;/span>
&lt;span style="color:#75715e">;; that test numbers for fizzery and buzzery, then we can&lt;/span>
&lt;span style="color:#75715e">;; construct a version of the truth table that is /concretely/&lt;/span>
&lt;span style="color:#75715e">;; specific to FizzBuzz.&lt;/span>
(&lt;span style="color:#a6e22e">comment&lt;/span>
(= (map (&lt;span style="color:#a6e22e">mechanism&lt;/span> fizzes? buzzes?)
[&lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>])
[[true true]
[true false]
[false true]
[false false]])
)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Finally, we hang it all together with Clojure&amp;rsquo;s multimethods &lt;sup id="fnref:17">&lt;a href="#fn:17" class="footnote-ref" role="doc-noteref">17&lt;/a>&lt;/sup>, like so.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">ns &lt;/span>dispatch.buzz)
(&lt;span style="color:#66d9ef">def &lt;/span>fizz-buzz map)
(&lt;span style="color:#66d9ef">def &lt;/span>fizz-buzz-mechanism
(&lt;span style="color:#a6e22e">mechanism&lt;/span> fizzes? buzzes?))
(&lt;span style="color:#66d9ef">defmulti &lt;/span>dispatch-buzz
&lt;span style="color:#e6db74">&amp;#34;It yields the third column of the truth table.&amp;#34;&lt;/span>
fizz-buzz-mechanism)
&lt;span style="color:#75715e">;; The /Policy/, fully realised.&lt;/span>
&lt;span style="color:#75715e">;; ((mechanism fizzes? buzzes?) n) -&amp;gt; final results&lt;/span>
(&lt;span style="color:#66d9ef">defmethod &lt;/span>dispatch-buzz [true true]
[n]
&lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>)
(&lt;span style="color:#66d9ef">defmethod &lt;/span>dispatch-buzz [true false]
[n]
&lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>)
(&lt;span style="color:#66d9ef">defmethod &lt;/span>dispatch-buzz [false true]
[n]
&lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>)
(&lt;span style="color:#66d9ef">defmethod &lt;/span>dispatch-buzz &lt;span style="color:#e6db74">:default&lt;/span>
[n]
n)
&lt;span style="color:#75715e">;; The /Policy/, applied.&lt;/span>
(&lt;span style="color:#a6e22e">comment&lt;/span>
(= (&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> dispatch-buzz
[&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#ae81ff">16&lt;/span>])
[&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">16&lt;/span>])
)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Yes, &amp;lsquo;tis a wee FizzBuzz interpreter!&lt;/p>
&lt;p>(Pirouettes off-stage, gracefully.)&lt;/p>
&lt;h2 id="embarrassingly-parallel-fizzbuzz">Embarrassingly Parallel FizzBuzz&lt;/h2>
&lt;p>It turns out FizzBuzz is one of those so-called &lt;a href="https://en.wikipedia.org/wiki/Embarrassingly%5Fparallel">Embarrassingly Parallel&lt;/a> problems.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">ns &lt;/span>all.them.fizz.buzzers)
(&lt;span style="color:#66d9ef">def &lt;/span>fizz-buzz map)
&lt;span style="color:#75715e">;; Add 1 character for parallel map.&lt;/span>
(&lt;span style="color:#66d9ef">def &lt;/span>embarrassingly-parallel-fizz-buzz pmap)
(&lt;span style="color:#a6e22e">comment&lt;/span>
(&lt;span style="color:#66d9ef">let &lt;/span>[range-of-buzzees (range &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">101&lt;/span>)]
(= (&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> basic-buzz
range-of-buzzees)
(&lt;span style="color:#a6e22e">embarrassingly-parallel-fizz-buzz&lt;/span> basic-buzz
range-of-buzzees)))
)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I was almost too embarrassed to write this, but I&amp;rsquo;m glad good sense prevailed,
because the trivial replacement of &lt;code>map&lt;/code> with &lt;code>pmap&lt;/code> teaches a lesson.&lt;/p>
&lt;p>Parallelism is impossibly hard if we don&amp;rsquo;t have pure functions, immutability,
and laziness. When we do, it reduces to merely hard but tractable. The
proverbial single character code modification (in this case, literally so)
gets a free ride on those other constructs.&lt;/p>
&lt;p>We can see it in &lt;code>pmap&lt;/code>&amp;rsquo;s implementation. It is fairly straightforward. Fetch
its source and stare at it for a bit; &lt;code>(clojure.repl/source pmap)&lt;/code>. You will
be able to make sense of it with a bit of cross-referencing ClojureDocs.&lt;/p>
&lt;p>If your favourite language has something similar (parallel version of a
sequential function), and if you choose to compare implementations, I will
be delighted to learn from your analysis!&lt;/p>
&lt;h2 id="oop-buzz">OOP Buzz&lt;/h2>
&lt;p>What is an Object in, say, Java? It is a combination of four distinct things:&lt;/p>
&lt;ul>
&lt;li>Name (Class name / Java type)&lt;/li>
&lt;li>Structure (Class members, methods etc.)&lt;/li>
&lt;li>Behaviour (effects caused by methods)&lt;/li>
&lt;li>State (contained in the run-time instance of the Class)&lt;/li>
&lt;/ul>
&lt;p>In Clojure, &lt;em>all of these are separate&lt;/em> (&amp;ldquo;available a la carte&amp;rdquo;, in Clojurish),
the consequences of which are hard to explain sans a motivating example.&lt;/p>
&lt;p>Clojure&amp;rsquo;s approach to Polymorphism allow us to do things like this.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">ns &lt;/span>oops.fizzbuzz)
(&lt;span style="color:#66d9ef">def &lt;/span>divisible? (comp zero? rem))
(&lt;span style="color:#66d9ef">def &lt;/span>fizz-buzz map)
&lt;span style="color:#75715e">;; Like a Java Interface, but better.&lt;/span>
(&lt;span style="color:#66d9ef">defprotocol &lt;/span>IFizzBuzz
(&lt;span style="color:#a6e22e">proto-buzz&lt;/span> [this]))
&lt;span style="color:#75715e">;; We can add new behaviour to existing types,&lt;/span>
&lt;span style="color:#75715e">;; including /any/ Java built-in type.&lt;/span>
(&lt;span style="color:#a6e22e">extend-protocol&lt;/span> IFizzBuzz
java.lang.Number
(&lt;span style="color:#a6e22e">proto-buzz&lt;/span> [this]
(&lt;span style="color:#a6e22e">cond&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> this &lt;span style="color:#ae81ff">15&lt;/span>) &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> this &lt;span style="color:#ae81ff">3&lt;/span>) &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> this &lt;span style="color:#ae81ff">5&lt;/span>) &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">:else&lt;/span> this)))
(&lt;span style="color:#a6e22e">comment&lt;/span>
&lt;span style="color:#75715e">;; Now we can do this&lt;/span>
(= (&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> proto-buzz
[&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#ae81ff">16&lt;/span>])
[&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">16&lt;/span>])
&lt;span style="color:#75715e">;; And we can also do this&lt;/span>
(= (&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> proto-buzz
[&lt;span style="color:#ae81ff">1.0&lt;/span> &lt;span style="color:#ae81ff">3.0&lt;/span> &lt;span style="color:#ae81ff">5.0&lt;/span> &lt;span style="color:#ae81ff">15.0&lt;/span> &lt;span style="color:#ae81ff">15.9&lt;/span>])
[&lt;span style="color:#ae81ff">1.0&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Fizz&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;Buzz&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;FizzBuzz&amp;#34;&lt;/span> &lt;span style="color:#ae81ff">15.9&lt;/span>])
&lt;span style="color:#75715e">;; WITHOUT breaking any existing Equality semantics.&lt;/span>
&lt;span style="color:#75715e">;; (= 42 42) =&amp;gt; true (long and long)&lt;/span>
&lt;span style="color:#75715e">;; (= 42 42.0) =&amp;gt; false (long and double)&lt;/span>
&lt;span style="color:#75715e">;; (= 42.0 42.0) =&amp;gt; true (double and double)&lt;/span>
&lt;span style="color:#75715e">;; Thus, this is false, as it should be.&lt;/span>
(= (&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> proto-buzz
[&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#ae81ff">16&lt;/span>])
(&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> proto-buzz
[&lt;span style="color:#ae81ff">1.0&lt;/span> &lt;span style="color:#ae81ff">3.0&lt;/span> &lt;span style="color:#ae81ff">5.0&lt;/span> &lt;span style="color:#ae81ff">15.0&lt;/span> &lt;span style="color:#ae81ff">15.9&lt;/span>]))
)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>In short, Clojure cleanly solves the &amp;ldquo;&lt;a href="https://en.wikipedia.org/wiki/Expression%5Fproblem">Expression Problem&lt;/a>&amp;rdquo;.&lt;/p>
&lt;p>In long, you can&amp;hellip;&lt;/p>
&lt;ul>
&lt;li>Watch &lt;a href="https://www.youtube.com/watch?v=kQhOlWXXl2I">Clojure Protocols Explained&lt;/a>, by Sean Devlin.&lt;/li>
&lt;li>Watch &lt;a href="https://www.infoq.com/presentations/Clojure-Expression-Problem/">Clojure&amp;rsquo;s Solutions to the Expression Problem&lt;/a>, by Chris Houser.&lt;/li>
&lt;li>Listen to &lt;a href="https://www.infoq.com/interviews/hickey-clojure-protocols/">Rich Hickey on Protocols and Clojure 1.3&lt;/a>, by Rich Hickey.&lt;/li>
&lt;li>Read &amp;ldquo;&lt;a href="https://gist.github.com/reborg/dc8b0c96c397a56668905e2767fd697f">Rich Already Answered That!&lt;/a>&amp;rdquo;, curated by reborg.
&lt;em>&amp;ldquo;A list of commonly asked questions, design decisions, reasons why Clojure
is the way it is as they were answered directly by Rich.&amp;quot;&lt;/em>&lt;/li>
&lt;/ul>
&lt;p>Lastly, not to put too fine a point on it, but Clojure is a &lt;em>far more capable&lt;/em>
Object Oriented Programming System than say Java or Kotlin, a fact which I
have personally profited from handsomely in the past &lt;sup id="fnref:18">&lt;a href="#fn:18" class="footnote-ref" role="doc-noteref">18&lt;/a>&lt;/sup>.&lt;/p>
&lt;h2 id="non-destructive-fizzbuzz">Non-Destructive FizzBuzz&lt;/h2>
&lt;p>&lt;code>proto-buzz&lt;/code> is a great motivating example of what I would like to call the
&lt;em>&lt;strong>Non-Destructive&lt;/strong>&lt;/em> FizzBuzz.&lt;/p>
&lt;p>All the FizzBuzz solutions seen previously, except PeanoBuzz, lose information.
This is almost always bad because its impossible to reverse information loss.
The inverse is also true. It is almost always good to &lt;em>augment&lt;/em> information.
Prefer to enrich information and retain as much as resources permit (organised
neatly, of course). Ask any lawyer or accountant or friendly neighbourhood
Clojurian which alternative would set their hair on fire.&lt;/p>
&lt;p>Here I play with some more ways to FizzBuzz non-destructively.&lt;/p>
&lt;p>As I do, I meditate upon the extra super nice thing about &lt;code>proto-buzz&lt;/code>.
Which is that we did &lt;em>not&lt;/em> have to invent a new number system or box numbers
in some composite FizzBuzz data representation &lt;em>and&lt;/em> we lost no functionality
&amp;mdash; numbers still behave exactly as we expect, with zero added overhead!&lt;/p>
&lt;h3 id="composite-data-buzz">Composite Data Buzz&lt;/h3>
&lt;p>PeanoBuzz was an example of writing FizzBuzz in terms of &amp;ldquo;composite&amp;rdquo; data.
Abstractly, that idea is basically &amp;ldquo;attach some meta-data to my things&amp;rdquo;.&lt;/p>
&lt;p>PeanoBuzz was a tuple &lt;code>[3 &amp;quot;Fizz&amp;quot;]&lt;/code>, but it could very well have been a custom
map representation, say, &lt;code>{:n 3 :fizzbuzz &amp;quot;Fizz&amp;quot;}&lt;/code>.&lt;/p>
&lt;p>We can do one better by using Clojure Records to attach full-blooded Java
types to our numbers &lt;sup id="fnref:19">&lt;a href="#fn:19" class="footnote-ref" role="doc-noteref">19&lt;/a>&lt;/sup> &lt;em>and also&lt;/em> make &amp;ldquo;composite&amp;rdquo; data, because
Records give us all the features of generic hash-maps for free.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">ns &lt;/span>boxed.fizz.buzz)
(&lt;span style="color:#66d9ef">def &lt;/span>divisible? (comp zero? rem))
(&lt;span style="color:#66d9ef">def &lt;/span>fizz-buzz map)
(&lt;span style="color:#66d9ef">defrecord &lt;/span>Fizz [n])
(&lt;span style="color:#66d9ef">defrecord &lt;/span>Buzz [n])
(&lt;span style="color:#66d9ef">defrecord &lt;/span>FizzBuzz [n])
(&lt;span style="color:#66d9ef">defrecord &lt;/span>Identity [n])
(&lt;span style="color:#66d9ef">defn &lt;/span>boxed-buzz
[n]
(&lt;span style="color:#a6e22e">cond&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">15&lt;/span>) (&lt;span style="color:#a6e22e">-&amp;gt;FizzBuzz&lt;/span> n)
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">3&lt;/span>) (&lt;span style="color:#a6e22e">-&amp;gt;Fizz&lt;/span> n)
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">5&lt;/span>) (&lt;span style="color:#a6e22e">-&amp;gt;Buzz&lt;/span> n)
&lt;span style="color:#e6db74">:else&lt;/span> (&lt;span style="color:#a6e22e">-&amp;gt;Identity&lt;/span> n)))
(&lt;span style="color:#66d9ef">def &lt;/span>all-boxed-buzzes
(map boxed-buzz
(rest (&lt;span style="color:#a6e22e">range&lt;/span>))))
(&lt;span style="color:#a6e22e">comment&lt;/span>
&lt;span style="color:#75715e">;; Composite hash-map-like data!&lt;/span>
(= (&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> boxed-buzz
[&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>])
[&lt;span style="color:#f92672">#&lt;/span>boxed.fizz.buzz.Identity{&lt;span style="color:#e6db74">:n&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>}
&lt;span style="color:#f92672">#&lt;/span>boxed.fizz.buzz.Fizz{&lt;span style="color:#e6db74">:n&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span>}
&lt;span style="color:#f92672">#&lt;/span>boxed.fizz.buzz.Buzz{&lt;span style="color:#e6db74">:n&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>}
&lt;span style="color:#f92672">#&lt;/span>boxed.fizz.buzz.FizzBuzz{&lt;span style="color:#e6db74">:n&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>}]) &lt;span style="color:#75715e">; =&amp;gt; true&lt;/span>
&lt;span style="color:#75715e">;; Which is nondestructive!&lt;/span>
(= [&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>]
(&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> (comp &lt;span style="color:#e6db74">:n&lt;/span> boxed-buzz)
[&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>])) &lt;span style="color:#75715e">; =&amp;gt; true&lt;/span>
&lt;span style="color:#75715e">;; And which has real Java types!&lt;/span>
(= (map type (&lt;span style="color:#a6e22e">fizz-buzz&lt;/span> boxed-buzz [&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>]))
[boxed.fizz.buzz.Identity
boxed.fizz.buzz.Fizz
boxed.fizz.buzz.Buzz
boxed.fizz.buzz.FizzBuzz]) &lt;span style="color:#75715e">; =&amp;gt; true&lt;/span>
)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Further exercises for the dear reader!&lt;/p>
&lt;ul>
&lt;li>Re-implement PeanoBuzz using Clojure hash-maps!&lt;/li>
&lt;li>Re-re-implement PeanoBuzz with Records!&lt;/li>
&lt;li>&lt;em>Separately&lt;/em> write something that can return the classic string-or-number
equivalent of your composite types! (Hint: use multimethods and/or protocols
as appropriate).&lt;/li>
&lt;/ul>
&lt;p>Last but not least, ask yourself &amp;ldquo;But what about equality? And the rest of
arithmetic?&amp;rdquo; while comparing these with &lt;code>proto-buzz&lt;/code>.&lt;/p>
&lt;h3 id="clojure-spec-d-buzz">Clojure Spec&amp;rsquo;d Buzz&lt;/h3>
&lt;p>Off-label use of &lt;a href="https://clojure.org/guides/spec">Clojure Spec&lt;/a>&amp;rsquo;s &lt;code>conform&lt;/code> as a parser can be very handy.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">ns &lt;/span>conformer.buzz)
(&lt;span style="color:#a6e22e">require&lt;/span> &lt;span style="color:#f92672">&amp;#39;&lt;/span>[clojure.spec.alpha &lt;span style="color:#e6db74">:as&lt;/span> s])
(&lt;span style="color:#66d9ef">defn &lt;/span>divisible?
[divisor n]
(zero? (rem n divisor)))
(&lt;span style="color:#66d9ef">def &lt;/span>fizzes? (partial divisible? &lt;span style="color:#ae81ff">3&lt;/span>))
(&lt;span style="color:#66d9ef">def &lt;/span>buzzes? (partial divisible? &lt;span style="color:#ae81ff">5&lt;/span>))
(&lt;span style="color:#a6e22e">s/def&lt;/span> &lt;span style="color:#e6db74">::number&lt;/span> number?)
(&lt;span style="color:#a6e22e">s/def&lt;/span> &lt;span style="color:#e6db74">::fizzes&lt;/span> (&lt;span style="color:#a6e22e">s/and&lt;/span> &lt;span style="color:#e6db74">::number&lt;/span> fizzes?))
(&lt;span style="color:#a6e22e">s/def&lt;/span> &lt;span style="color:#e6db74">::buzzes&lt;/span> (&lt;span style="color:#a6e22e">s/and&lt;/span> &lt;span style="color:#e6db74">::number&lt;/span> buzzes?))
(&lt;span style="color:#a6e22e">comment&lt;/span>
&lt;span style="color:#75715e">;; Now we can parse input data...&lt;/span>
(&lt;span style="color:#a6e22e">s/conform&lt;/span> &lt;span style="color:#e6db74">::fizzes&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span>) &lt;span style="color:#75715e">; =&amp;gt; 3&lt;/span>
(&lt;span style="color:#a6e22e">s/conform&lt;/span> &lt;span style="color:#e6db74">::buzzes&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>) &lt;span style="color:#75715e">; =&amp;gt; 5&lt;/span>
(&lt;span style="color:#a6e22e">s/conform&lt;/span> &lt;span style="color:#e6db74">::buzzes&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span>) &lt;span style="color:#75715e">; =&amp;gt; :clojure.spec.alpha/invalid&lt;/span>
(&lt;span style="color:#a6e22e">s/conform&lt;/span> (&lt;span style="color:#a6e22e">s/and&lt;/span> &lt;span style="color:#e6db74">::fizzes&lt;/span> &lt;span style="color:#e6db74">::buzzes&lt;/span>) &lt;span style="color:#ae81ff">15&lt;/span>) &lt;span style="color:#75715e">; =&amp;gt; 15&lt;/span>
&lt;span style="color:#75715e">;; And we can handle non-conforming data gracefully,&lt;/span>
&lt;span style="color:#75715e">;; instead of panicking and throwing exceptions.&lt;/span>
(&lt;span style="color:#a6e22e">s/conform&lt;/span> (&lt;span style="color:#a6e22e">s/or&lt;/span> &lt;span style="color:#e6db74">::fizzes&lt;/span> &lt;span style="color:#e6db74">::buzzes&lt;/span>) &lt;span style="color:#e6db74">&amp;#34;lol&amp;#34;&lt;/span>) &lt;span style="color:#75715e">; :clojure.spec.alpha/invalid&lt;/span>
)
(&lt;span style="color:#66d9ef">def &lt;/span>fizz-buzz-specs
&lt;span style="color:#e6db74">&amp;#34;Set of FizzBuzz parsers.&amp;#34;&lt;/span>
&lt;span style="color:#f92672">#&lt;/span>{&lt;span style="color:#e6db74">::fizzes&lt;/span> &lt;span style="color:#e6db74">::buzzes&lt;/span> &lt;span style="color:#e6db74">::number&lt;/span>})
(&lt;span style="color:#66d9ef">defn &lt;/span>spec-parse-buzz
&lt;span style="color:#e6db74">&amp;#34;Conform the given input to the set of specs for fizz-buzz, and return
&lt;/span>&lt;span style="color:#e6db74"> a pair of the input and a map of parsed values keyed by the parser name.&amp;#34;&lt;/span>
[x]
[x (zipmap fizz-buzz-specs
(map &lt;span style="color:#f92672">#&lt;/span>(&lt;span style="color:#a6e22e">s/conform&lt;/span> % x) fizz-buzz-specs))])
(&lt;span style="color:#66d9ef">def &lt;/span>all-spec-buzzes
(map spec-parse-buzz
(rest (&lt;span style="color:#a6e22e">range&lt;/span>))))
(&lt;span style="color:#a6e22e">comment&lt;/span>
&lt;span style="color:#75715e">;; And we can...&lt;/span>
(take &lt;span style="color:#ae81ff">100&lt;/span> all-spec-buzzes)
&lt;span style="color:#75715e">;; Which gives us enriched data, like this:&lt;/span>
(= (into {} (map spec-parse-buzz [&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#e6db74">&amp;#34;lol&amp;#34;&lt;/span>]))
{&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">#&lt;/span>&lt;span style="color:#e6db74">:conformer.buzz&lt;/span>{&lt;span style="color:#e6db74">:fizzes&lt;/span> &lt;span style="color:#e6db74">:clojure.spec.alpha/invalid&lt;/span>,
&lt;span style="color:#e6db74">:buzzes&lt;/span> &lt;span style="color:#e6db74">:clojure.spec.alpha/invalid&lt;/span>,
&lt;span style="color:#e6db74">:number&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>},
&lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#f92672">#&lt;/span>&lt;span style="color:#e6db74">:conformer.buzz&lt;/span>{&lt;span style="color:#e6db74">:fizzes&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span>,
&lt;span style="color:#e6db74">:buzzes&lt;/span> &lt;span style="color:#e6db74">:clojure.spec.alpha/invalid&lt;/span>,
&lt;span style="color:#e6db74">:number&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span>},
&lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#f92672">#&lt;/span>&lt;span style="color:#e6db74">:conformer.buzz&lt;/span>{&lt;span style="color:#e6db74">:fizzes&lt;/span> &lt;span style="color:#e6db74">:clojure.spec.alpha/invalid&lt;/span>,
&lt;span style="color:#e6db74">:buzzes&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>,
&lt;span style="color:#e6db74">:number&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span>},
&lt;span style="color:#ae81ff">15&lt;/span> &lt;span style="color:#f92672">#&lt;/span>&lt;span style="color:#e6db74">:conformer.buzz&lt;/span>{&lt;span style="color:#e6db74">:fizzes&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>,
&lt;span style="color:#e6db74">:buzzes&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>,
&lt;span style="color:#e6db74">:number&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>},
&lt;span style="color:#e6db74">&amp;#34;lol&amp;#34;&lt;/span> &lt;span style="color:#f92672">#&lt;/span>&lt;span style="color:#e6db74">:conformer.buzz&lt;/span>{&lt;span style="color:#e6db74">:fizzes&lt;/span> &lt;span style="color:#e6db74">:clojure.spec.alpha/invalid&lt;/span>,
&lt;span style="color:#e6db74">:buzzes&lt;/span> &lt;span style="color:#e6db74">:clojure.spec.alpha/invalid&lt;/span>,
&lt;span style="color:#e6db74">:number&lt;/span> &lt;span style="color:#e6db74">:clojure.spec.alpha/invalid&lt;/span>}}) &lt;span style="color:#75715e">; =&amp;gt; true&lt;/span>
)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>However, like off-label use of anything, this &lt;code>conform&lt;/code>-as-parser trick too
skirts the &amp;ldquo;can be a very bad idea&amp;rdquo; territory.&lt;/p>
&lt;p>YMMV.&lt;/p>
&lt;h3 id="wicked-pprint-buzz">Wicked pprint Buzz&lt;/h3>
&lt;p>&lt;a href="https://twitter.com/rdivyanshu">@rdivyanshu&lt;/a> said to add this extra &lt;a href="https://github.com/clojure/clojure/blob/b1b88dd25373a86e41310a525a21b497799dbbf2/src/clj/clojure/pprint/dispatch.clj#L175">pprint dispatcher&lt;/a>,
&lt;em>&amp;ldquo;and let no number escape fizzbuzzness when showing itself&amp;rdquo;&lt;/em>.&lt;/p>
&lt;p>Why not?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">ns &lt;/span>pprint.buzz)
(&lt;span style="color:#a6e22e">require&lt;/span> &lt;span style="color:#f92672">&amp;#39;&lt;/span>[clojure.pprint &lt;span style="color:#e6db74">:as&lt;/span> pp])
(&lt;span style="color:#66d9ef">defn &lt;/span>pprint-buzz
[n]
(&lt;span style="color:#66d9ef">let &lt;/span>[divisible? (comp zero? rem)
prettyprint (comp prn
(partial format &lt;span style="color:#e6db74">&amp;#34;%d doth %s&amp;#34;&lt;/span>))]
(&lt;span style="color:#a6e22e">cond&lt;/span>
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">15&lt;/span>) (&lt;span style="color:#a6e22e">prettyprint&lt;/span> n &lt;span style="color:#e6db74">&amp;#34;FizzBuzzeth&amp;#34;&lt;/span>)
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">3&lt;/span>) (&lt;span style="color:#a6e22e">prettyprint&lt;/span> n &lt;span style="color:#e6db74">&amp;#34;Fizzeth&amp;#34;&lt;/span>)
(&lt;span style="color:#a6e22e">divisible?&lt;/span> n &lt;span style="color:#ae81ff">5&lt;/span>) (&lt;span style="color:#a6e22e">prettyprint&lt;/span> n &lt;span style="color:#e6db74">&amp;#34;Buzzeth&amp;#34;&lt;/span>)
&lt;span style="color:#e6db74">:else&lt;/span> (&lt;span style="color:#a6e22e">prettyprint&lt;/span> n &lt;span style="color:#e6db74">&amp;#34;not Fizzeth nor Buzzeth. Alas!&amp;#34;&lt;/span>))))
(&lt;span style="color:#a6e22e">comment&lt;/span>
&lt;span style="color:#75715e">;; lol&lt;/span>
(&lt;span style="color:#f92672">#&lt;/span>&lt;span style="color:#e6db74">&amp;#39;pp/use-method&lt;/span> pp/simple-dispatch java.lang.Number pprint-buzz)
&lt;span style="color:#75715e">;; nothing to see here... you will have to look at the REPL&lt;/span>
(doseq [n [&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span> &lt;span style="color:#ae81ff">5&lt;/span> &lt;span style="color:#ae81ff">15&lt;/span>]]
(&lt;span style="color:#a6e22e">pp/pprint&lt;/span> n)) &lt;span style="color:#75715e">;; lol lol lol lolllll&lt;/span>
)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>You, Sir, are truly a gentlenerd and a scholar.&lt;/p>
&lt;p>Nondestructive, and hilarious to boot!&lt;/p>
&lt;h3 id="tagged-literal-buzz">Tagged Literal Buzz&lt;/h3>
&lt;p>Thinking aloud&amp;hellip;&lt;/p>
&lt;p>Clojure has a concept of &amp;ldquo;tagged literals&amp;rdquo;; plaintext labels that we can
&amp;ldquo;attach&amp;rdquo; to data &lt;em>without&lt;/em> changing the literal value of our data, &lt;em>and&lt;/em>
transmit over wires along with the data.&lt;/p>
&lt;p>Clojure provides built-in support for a small set of some fairly universal
types of literals (instant, UUID etc.). And I have used fancier tagged
literals, but only in context of other people&amp;rsquo;s libraries (&lt;a href="https://github.com/juxt/aero">juxt/aero&lt;/a>).&lt;/p>
&lt;p>How to make this work, I wonder?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">ns &lt;/span>tagged.buzz)
&lt;span style="color:#75715e">;; We can do this, but how to work with it?&lt;/span>
(&lt;span style="color:#a6e22e">set!&lt;/span> *default-data-reader-fn* tagged-literal)
(&lt;span style="color:#66d9ef">def &lt;/span>tagged-buzz
&lt;span style="color:#f92672">#&lt;/span>tagged.buzz/FizzBuzzSequence [&lt;span style="color:#f92672">#&lt;/span>tagged.buzz/Fizz &lt;span style="color:#ae81ff">3&lt;/span>
&lt;span style="color:#f92672">#&lt;/span>tagged.buzz/Buzz &lt;span style="color:#ae81ff">5&lt;/span>
&lt;span style="color:#f92672">#&lt;/span>tagged.buzz/FizzBuzz &lt;span style="color:#ae81ff">15&lt;/span>
&lt;span style="color:#f92672">#&lt;/span>tagged.buzz/Number &lt;span style="color:#ae81ff">1&lt;/span>])
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Anyway, it&amp;rsquo;s way past 3 AM now.&lt;/p>
&lt;p>Maybe tomorrow.&lt;/p>
&lt;p>I mean, later today.&lt;/p>
&lt;h2 id="buzz">&lt;!-- raw HTML omitted -->TODO&lt;!-- raw HTML omitted --> Buzz&lt;/h2>
&lt;p>Ideas on deck, to put self on the hook&amp;hellip;&lt;/p>
&lt;ul>
&lt;li>&lt;input disabled="" type="checkbox"> curried fizzbuzz (like Ring libraries),&lt;/li>
&lt;li>&lt;input checked="" disabled="" type="checkbox"> dispatch-based fizzbuzz (with multimethods),&lt;/li>
&lt;li>&lt;input checked="" disabled="" type="checkbox"> OOP fizzbuzz (with protocols),&lt;/li>
&lt;li>&lt;input checked="" disabled="" type="checkbox"> Nondestructive fizzbuzz (several!!!),&lt;/li>
&lt;li>&lt;input disabled="" type="checkbox"> concurrent fizzbuzz (with agents, but the code in my head is
probably totally wrong),&lt;/li>
&lt;li>&lt;input checked="" disabled="" type="checkbox"> parallel fizzbuzz, (just pmap, quite silly actually, but why not? It&amp;rsquo;s legit!)&lt;/li>
&lt;li>&lt;input disabled="" type="checkbox"> transducing fizzbuzz, (should be able to transduce all the fizz-buzzes
up to Peano FizzBuzz)&lt;/li>
&lt;li>&lt;input disabled="" type="checkbox"> maaabe also re-do Rich&amp;rsquo;s ants sim with FizzBuzz ants (4 species of, ah,
ConcurrAnts &amp;mdash; IdentiAnt, FizzAnt, BuzzAnt, FizzBuzzAnt).&lt;/li>
&lt;/ul>
&lt;p>Outside of clojure.core, maaaaybe core.async fizzbuzz, but IDK, maybe that
will be too high concept, and too contrived.&lt;/p>
&lt;h2 id="acknowledgments">Acknowledgments&lt;/h2>
&lt;p>Thanks to &lt;a href="https://twitter.com/rdivyanshu">@rdivyanshu&lt;/a> for review and feedback and ideas.&lt;/p>
&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>Official and community-curated Clojure API docs &lt;a href="https://clojure.org/api/api">https://clojure.org/api/api&lt;/a>&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:2" role="doc-endnote">
&lt;p>Official guide: &lt;a href="https://clojure.org/guides/repl/introduction">Programming at the REPL&lt;/a>. The REPL is an &lt;em>eager&lt;/em> beast. Lazy sequences want to never be fully realised, if possible. But, a REPL is typically designed to fully evaluate everything it gets. This is why we didn&amp;rsquo;t feel the bite of mixing printing with lazy sequence generation. If we had this in our code somewhere, nothing would print, and any caller would get back just a useless collection of nils.&amp;#160;&lt;a href="#fnref:2" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:3" role="doc-endnote">
&lt;p>Laziness is a form of deferred computation. Clojure has &amp;ldquo;lazy sequences&amp;rdquo;. &lt;code>for&lt;/code> generates a lazy sequence. Several essay-length answers await your eager perusal. Rich Hickey&amp;rsquo;s notes from back in the day: &lt;a href="https://clojure.org/reference/lazy">Making Clojure Lazier&lt;/a>. Ramsharan G.J. muses &lt;em>&amp;quot;&lt;a href="https://www.youtube.com/watch?v=XCYTvZtTetI">Lazy Seqs - Why are they so lazy?&lt;/a>&amp;quot;&lt;/em> (&lt;a href="https://speakerdeck.com/sharangj/lazy-sequences-why-are-they-so-lazy">slides&lt;/a>). Oitihjya Sen muses &lt;a href="https://otee.dev/2022/01/17/lazy-clojure.html">Who Moved My Cheese: Laziness in Clojure&lt;/a>. Debashish Ghose has some thoughts on &lt;a href="https://debasishg.blogspot.com/2010/05/laziness-in-clojure-some-thoughts.html">Laziness in Clojure&lt;/a>.&amp;#160;&lt;a href="#fnref:3" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:4" role="doc-endnote">
&lt;p>Watch Rafal Dittwald refactor some Javascript in &lt;a href="https://www.youtube.com/watch?v=vK1DazRK%5Fa0">Solving Problems the Clojure Way&lt;/a>. Basically, we like to &lt;em>prevent&lt;/em> side effecting code as much as humanely possible. When we can&amp;rsquo;t, we do &lt;a href="https://www.destroyallsoftware.com/screencasts/catalog/functional-core-imperative-shell">Functional Core Imperative Shell&lt;/a>.&amp;#160;&lt;a href="#fnref:4" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:5" role="doc-endnote">
&lt;p>The &lt;a href="https://mitpress.mit.edu/sites/default/files/sicp/index.html">full SICP textbook&lt;/a> is available free, online. The &lt;a href="https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-001-structure-and-interpretation-of-computer-programs-spring-2005/video-lectures/">video lecture series&lt;/a> from 1986. Further DuckDuck searches will yield various tours of SICP in Clojure. Still further into the deep end, there is now &lt;a href="https://github.com/sicmutils">SICMUtils&lt;/a> in Clojure, built around the Structure and Interpretation of Classical Mechanics.&amp;#160;&lt;a href="#fnref:5" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:6" role="doc-endnote">
&lt;p>To anyone writing Clojure tutorials, please for the love of lambda, &lt;em>&lt;strong>do not&lt;/strong>&lt;/em> use &lt;code>println&lt;/code> to &amp;ldquo;show&amp;rdquo; people results. You may think you are being kind by using a familiar way to &amp;ldquo;show&amp;rdquo; results, but it is far better to rip the bandage off right from the get go. Double down on teaching good REPL habits and quality FP thinking instead.&amp;#160;&lt;a href="#fnref:6" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:7" role="doc-endnote">
&lt;p>Incidentally, the Classic implementation is also sensitive to the ordering of conditions, which is also a defect from a FP point of view, because there is no good reason to write an imperative control-flow-y interpretation of what could be a purely mathematical definition of FizzBuzz.&amp;#160;&lt;a href="#fnref:7" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:8" role="doc-endnote">
&lt;p>Well, maybe Rich can convince you otherwise: &lt;a href="https://www.infoq.com/presentations/Simple-Made-Easy/">Simple Made Easy&lt;/a>.&amp;#160;&lt;a href="#fnref:8" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:9" role="doc-endnote">
&lt;p>I mean, don&amp;rsquo;t be actively malicious, of course. However, such a &lt;em>category&lt;/em> of error can happen. And if &amp;ldquo;they&amp;rdquo; git-blame-fire you, then I&amp;rsquo;d say celebrate. You inadvertently self-evicted from a place that will destroy your soul with bad systems and bad management.&amp;#160;&lt;a href="#fnref:9" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:10" role="doc-endnote">
&lt;p>One fine day, one of our Clojure services at $FormerEmployer, started to run out of heap space after a fresh deployment. Our service graphs looked like this &lt;code>_/|_/|_/|_&lt;/code>. The sawtooth of heap death. It wasn&amp;rsquo;t super critical, and everybody was busy shipping features. So naturally we did some napkin math and rolled out a Jenkins job that triggered a rolling restart every six hours. Eventually, someone found the time to go debug the crashes. We had &lt;em>memoized&lt;/em> a function that returned an anonymous function (a lambda or &lt;em>thunk&lt;/em>), when we meant to memoize the return value from evaluating said lambda. Clojure creates a &lt;em>new&lt;/em> object every time we ask it to make a lambda. So &lt;a href="https://clojuredocs.org/clojure.core/memoize">memoize&lt;/a> saw new return values every time the original &amp;ldquo;thunkified&amp;rdquo; function was called, dutifully cached them all, and held onto them, thus preventing JVM garbage collector from cleaning them out. The story is relevant here because &lt;em>thunking&lt;/em> (making functions return partially evaluated fuctions) is a form of delayed or &amp;ldquo;lazy&amp;rdquo; evaluation. Also because nobody was fired. Everyone learned a good lesson and had a good laugh. In fact, we continued to use the rolling restart job in at least one other case where the memory leak was very slow, the service was very fault tolerant, and the service owner was really pressed for time with other always-higher priorities in that hyper-growth phase of the company. Slow leak tolerance is very much justified when used carefully. In fact, the friend who owned that service recently told me the periodic restart method worked so well, that they almost forgot about it for several years until they did a whole data center migration, at which point the service crashed for the first time in years, because someone forgot to also switch on the restart job. More good laughs were had and the documentation and automation were improved. You may now like to read &lt;a href="https://devblogs.microsoft.com/oldnewthing/20180228-00/?p=98125">&lt;em>&amp;ldquo;An amusing story about a practical use of the null garbage collector&amp;rdquo;&lt;/em>&lt;/a>.&amp;#160;&lt;a href="#fnref:10" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:11" role="doc-endnote">
&lt;p>&amp;ldquo;&lt;a href="https://www.merriam-webster.com/dictionary/complect">Complect&lt;/a>&amp;quot;-ed, if you speak Clojurish. When a Thing is made of lots of Sub-Things that are braided together tightly, we say &amp;ldquo;This Thing is &lt;em>complected&lt;/em>.&amp;rdquo; in Clojurish. After we transform and reconstitute the Thing in terms of sub-things that are &lt;em>no longer&lt;/em> braided together, we smile inwardly and say &amp;ldquo;This Thing is now &lt;em>decomplected&lt;/em>&amp;rdquo;. Clojurish is basically a postmodern revival of the Latin roots of American English.&amp;#160;&lt;a href="#fnref:11" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:12" role="doc-endnote">
&lt;p>Eric Normand on &lt;em>&lt;a href="https://ericnormand.me/podcast/what-is-nil-punning">&amp;ldquo;What is Nil Punning?&amp;quot;&lt;/a>&lt;/em>.&amp;#160;&lt;a href="#fnref:12" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:13" role="doc-endnote">
&lt;p>For reference, &lt;a href="https://github.com/adityaathalye/sicp/blob/master/ex2-06-church-numerals.scm">my attempt&lt;/a> at implementing &lt;a href="https://en.wikipedia.org/wiki/Church%5Fencoding">Church Numerals&lt;/a> in SICP.&amp;#160;&lt;a href="#fnref:13" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:14" role="doc-endnote">
&lt;p>See the footnote for &amp;ldquo;Complect&amp;rdquo;.&amp;#160;&lt;a href="#fnref:14" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:15" role="doc-endnote">
&lt;p>Arne Brasseur on &lt;a href="https://www.lambdaisland.com/blog/2022-03-10-mechanism-vs-policy">Improve your code by separating mechanism from policy&lt;/a>. Don&amp;rsquo;t you just love it when Lots Of Thoughts are rattling around in your brain, and someone drops a sweet one-liner that instantly crystallises it all for you? Thanks &lt;a href="https://twitter.com/robstuttaford">@RobStuttaford&lt;/a> for bringing this back into my consciousness!&amp;#160;&lt;a href="#fnref:15" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:16" role="doc-endnote">
&lt;p>I see you and that &lt;code>AbstractFactoryFactory&lt;/code> joke forming in your brain.&amp;#160;&lt;a href="#fnref:16" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:17" role="doc-endnote">
&lt;p>See &lt;a href="https://clojure.org/reference/multimethods">Multimethods and Hierarchies&lt;/a> page at the official site, and the &lt;a href="https://clojuredocs.org/quickref#multifunctions">Multifunctions&lt;/a> section at ClojureDocs for examples. This stuff may break your brain for a bit, if you are very accustomed to Class-y OO programming. That&amp;rsquo;s absolutely fine. It &lt;em>is&lt;/em> fairly mind bending and takes some getting used to. Stay with it, play with concepts against the REPL. Translate or reduce as many patterns as you can to this kind of open-ended multiple dispatch.&amp;#160;&lt;a href="#fnref:17" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:18" role="doc-endnote">
&lt;p>You can watch me flail about live-demoing a UI test automation DSL I designed using Clojure. &lt;a href="https://www.youtube.com/watch?v=hwoLON80ZzA&amp;amp;t=170s">Video&lt;/a>, &lt;a href="https://github.com/adityaathalye/slideware/blob/master/designing%5Fobject%5Ffunctional%5Fsystem%5FIN-Clojure%5F2016.pdf">Slides&lt;/a>.&amp;#160;&lt;a href="#fnref:18" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:19" role="doc-endnote">
&lt;p>Aside: This is actually double-boxing, because in Java, numbers are already boxed by design. So this approach may carry some performance penalty depending on your context. For example, see this DZone &amp;gt; Java Zone article: &lt;a href="https://dzone.com/articles/whats-wrong-with-java-boxed-numbers">What&amp;rsquo;s Wrong With Java Boxed Numbers?&lt;/a>&amp;#160;&lt;a href="#fnref:19" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></content></item><item><title>Shell ain't a bad place to FP: part 1/N</title><link>/posts/shell-aint-a-bad-place-to-fp-part-1-doug-mcilroys-pipeline/</link><pubDate>Fri, 11 Mar 2022 00:08:52 +0530</pubDate><guid>/posts/shell-aint-a-bad-place-to-fp-part-1-doug-mcilroys-pipeline/</guid><description>&lt;p>Or, &lt;em>&lt;strong>the one in which we &amp;ldquo;take apart&amp;rdquo; Douglas McIlroy&amp;rsquo;s pipeline from 1986.&lt;/strong>&lt;/em>&lt;/p>
&lt;p>Doing so teaches an object lesson about the essence of modular, composable,
functional architecture. And things start to really heat up when it dawns on
us, how a good set of standard parts can be used to express totally different
ideas &lt;em>just by composing them in different ways&lt;/em>.&lt;/p>
&lt;p>(Edit 2022-03-10: speaking of lessons, how about the one in the appendix?!)&lt;/p>
&lt;blockquote>
&lt;p>&amp;ldquo;Designing is &lt;em>fundamentally&lt;/em> about taking things apart. It&amp;rsquo;s about taking
things apart &lt;em>in such a way&lt;/em> that they can be put back together. i.e.
Separating into things that can be composed.&amp;rdquo;&lt;/p>
&lt;ul>
&lt;li>Rich Hickey, &amp;ldquo;&lt;a href="https://www.youtube.com/watch?v=QCwqnjxqfmY">Design, Composition, and Performance&lt;/a>&amp;rdquo;, 2013&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">tr -cs A-Za-z &lt;span style="color:#e6db74">&amp;#39;\n&amp;#39;&lt;/span> | tr A-Z a-z | sort | uniq -c | sort -rn | sed 10q
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>Douglas McIlroy, &lt;a href="https://dl.acm.org/doi/10.1145/5948.315654">Communications of the ACM&lt;/a>, 1986&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;!-- raw HTML omitted -->
&lt;ul>
&lt;li>&lt;a href="#the-pipeline-that-douglas-built">The Pipeline that Douglas Built&lt;/a>&lt;/li>
&lt;li>&lt;a href="#take-apart-semantics-idioms-functions">Take Apart! Semantics/Idioms -&amp;gt; Functions&lt;/a>&lt;/li>
&lt;li>&lt;a href="#play-semantics-functions-ooh-what-if-i-dot-dot-dot">Play! Semantics -&amp;gt; Functions -&amp;gt; &amp;ldquo;Ooh, what if I&amp;hellip;&amp;quot;&lt;/a>&lt;/li>
&lt;li>&lt;a href="#compose-again-semantics-functions-play-grand-new-pipeline">Compose Again! Semantics -&amp;gt; Functions -&amp;gt; Play -&amp;gt; Grand New Pipeline&lt;/a>&lt;/li>
&lt;li>&lt;a href="#addendum-remarkable-aspects-of-doug-s-o-dot-g-dot-pipeline">Addendum: Remarkable aspects of Doug&amp;rsquo;s O.G. pipeline&lt;/a>&lt;/li>
&lt;li>&lt;a href="#appendix-an-unexpected-masterclass">Appendix: an unexpected masterclass!&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#the-danger-lurking-in-the-pipes">The danger lurking in the pipes&lt;/a>&lt;/li>
&lt;li>&lt;a href="#backstory">Backstory&lt;/a>&lt;/li>
&lt;li>&lt;a href="#postscript">Postscript&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;p>Previously: &lt;a href="https://evalapply.org/posts/shell-aint-a-bad-place-to-fp-part-0-intro/">Shell ain&amp;rsquo;t a bad place to FP: part 0/N&lt;/a>&lt;/p></description><content>&lt;p>Or, &lt;em>&lt;strong>the one in which we &amp;ldquo;take apart&amp;rdquo; Douglas McIlroy&amp;rsquo;s pipeline from 1986.&lt;/strong>&lt;/em>&lt;/p>
&lt;p>Doing so teaches an object lesson about the essence of modular, composable,
functional architecture. And things start to really heat up when it dawns on
us, how a good set of standard parts can be used to express totally different
ideas &lt;em>just by composing them in different ways&lt;/em>.&lt;/p>
&lt;p>(Edit 2022-03-10: speaking of lessons, how about the one in the appendix?!)&lt;/p>
&lt;blockquote>
&lt;p>&amp;ldquo;Designing is &lt;em>fundamentally&lt;/em> about taking things apart. It&amp;rsquo;s about taking
things apart &lt;em>in such a way&lt;/em> that they can be put back together. i.e.
Separating into things that can be composed.&amp;rdquo;&lt;/p>
&lt;ul>
&lt;li>Rich Hickey, &amp;ldquo;&lt;a href="https://www.youtube.com/watch?v=QCwqnjxqfmY">Design, Composition, and Performance&lt;/a>&amp;rdquo;, 2013&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">tr -cs A-Za-z &lt;span style="color:#e6db74">&amp;#39;\n&amp;#39;&lt;/span> | tr A-Z a-z | sort | uniq -c | sort -rn | sed 10q
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>Douglas McIlroy, &lt;a href="https://dl.acm.org/doi/10.1145/5948.315654">Communications of the ACM&lt;/a>, 1986&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;!-- raw HTML omitted -->
&lt;ul>
&lt;li>&lt;a href="#the-pipeline-that-douglas-built">The Pipeline that Douglas Built&lt;/a>&lt;/li>
&lt;li>&lt;a href="#take-apart-semantics-idioms-functions">Take Apart! Semantics/Idioms -&amp;gt; Functions&lt;/a>&lt;/li>
&lt;li>&lt;a href="#play-semantics-functions-ooh-what-if-i-dot-dot-dot">Play! Semantics -&amp;gt; Functions -&amp;gt; &amp;ldquo;Ooh, what if I&amp;hellip;&amp;quot;&lt;/a>&lt;/li>
&lt;li>&lt;a href="#compose-again-semantics-functions-play-grand-new-pipeline">Compose Again! Semantics -&amp;gt; Functions -&amp;gt; Play -&amp;gt; Grand New Pipeline&lt;/a>&lt;/li>
&lt;li>&lt;a href="#addendum-remarkable-aspects-of-doug-s-o-dot-g-dot-pipeline">Addendum: Remarkable aspects of Doug&amp;rsquo;s O.G. pipeline&lt;/a>&lt;/li>
&lt;li>&lt;a href="#appendix-an-unexpected-masterclass">Appendix: an unexpected masterclass!&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#the-danger-lurking-in-the-pipes">The danger lurking in the pipes&lt;/a>&lt;/li>
&lt;li>&lt;a href="#backstory">Backstory&lt;/a>&lt;/li>
&lt;li>&lt;a href="#postscript">Postscript&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;p>Previously: &lt;a href="https://evalapply.org/posts/shell-aint-a-bad-place-to-fp-part-0-intro/">Shell ain&amp;rsquo;t a bad place to FP: part 0/N&lt;/a>&lt;/p>
&lt;hr>
&lt;h2 id="the-pipeline-that-douglas-built">The Pipeline that Douglas Built&lt;/h2>
&lt;p>Douglas McIlroy famously (infamously?) wrote the following in reply to a
problem posed by Jon Bentley for his column &lt;em>&amp;ldquo;Programming pearls: a literate
program&amp;rdquo;&lt;/em> (&lt;em>Communications of the ACM&lt;/em> magazine, June 1986, Vol. 29, No. 6).&lt;/p>
&lt;p>I first heard of it some years ago in &lt;a href="https://leancrew.com/all-this/2011/12/more-shell-less-egg/">More Shell Less Egg&lt;/a>, and saw it again
in the book &lt;a href="https://www.oreilly.com/library/view/classic-shell-scripting/0596005954/">Classic Shell Scripting&lt;/a> (which taught me much of my shell-fu).
The original was not online then. Now I see the ACM has kindly &lt;a href="https://dl.acm.org/doi/10.1145/5948.315654">published it&lt;/a>
along with the rest of their archives!&lt;/p>
&lt;p>Here it is, lightly paraphrased:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#75715e"># Problem statement (word frequency):&lt;/span>
&lt;span style="color:#75715e">#&lt;/span>
&lt;span style="color:#75715e"># - Read a file of text&lt;/span>
&lt;span style="color:#75715e"># - Determine the n most frequently-used words&lt;/span>
&lt;span style="color:#75715e"># - Print out a sorted list of all the words, along with their frequencies&lt;/span>
&lt;span style="color:#75715e"># Douglas McIlroy&amp;#39;s answer&lt;/span>
&lt;span style="color:#75715e"># 1. Transliterate complement (-c) of words into newlines,&lt;/span>
&lt;span style="color:#75715e"># squeezing out (-s) duplicates&lt;/span>
tr -cs A-Za-z &lt;span style="color:#e6db74">&amp;#39;\n&amp;#39;&lt;/span> |
&lt;span style="color:#75715e"># 2. Transliterate uppercase to lowercase&lt;/span>
tr A-Z a-z |
&lt;span style="color:#75715e"># 3. Sort to bring identical words together&lt;/span>
sort |
&lt;span style="color:#75715e"># 4. Replace each run of duplicate words with&lt;/span>
&lt;span style="color:#75715e"># a single representative, and include a count&lt;/span>
uniq -c |
&lt;span style="color:#75715e"># 5. Sort reverse (-r), numeric (-n)&lt;/span>
sort -rn |
&lt;span style="color:#75715e"># 6. Pass through stream editor; quit after printing the&lt;/span>
&lt;span style="color:#75715e"># the first 10 lines received&lt;/span>
sed 10q
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Here I am, punching the Bash manual page through it&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">man bash |
tr -cs A-Za-z &lt;span style="color:#e6db74">&amp;#39;\n&amp;#39;&lt;/span> | tr A-Z a-z |
sort | uniq -c | sort -rn |
sed 10q
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&amp;hellip; and here are the top 10 words by frequency.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-text" data-lang="text">4200 the
1822 is
1251 to
1221 a
1147 of
869 if
805 and
570 shell
570 in
563 command
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&amp;ldquo;&lt;em>Coolcoolcoolcool nodoubt nodoubt&amp;hellip; So, uh&amp;hellip; that&amp;rsquo;s it?&lt;/em>&amp;rdquo;&lt;/p>
&lt;h2 id="take-apart-semantics-idioms-functions">Take Apart! Semantics/Idioms -&amp;gt; Functions&lt;/h2>
&lt;p>It&amp;rsquo;s worth observing that the &lt;em>same&lt;/em> tools composed in &lt;em>different&lt;/em> ways express
&lt;em>totally different&lt;/em> concepts. &lt;code>sort&lt;/code> just sorts. &lt;code>uniq&lt;/code> just returns uniques.
&lt;em>But&lt;/em> &lt;code>sort | uniq&lt;/code> is an idiom for &lt;em>set of things&lt;/em>. Whereas &lt;code>sort | uniq -c | sort -rn&lt;/code> is an idiom for &lt;em>frequency distribution&lt;/em>.&lt;/p>
&lt;p>Now&amp;hellip;&lt;/p>
&lt;p>What if we use Bash functions to name the idioms we see in McIlroy&amp;rsquo;s pipeline?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">flatten_paragraphs&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e"># English-only for easy explanation, but can be more general&lt;/span>
tr -cs A-Za-z &lt;span style="color:#e6db74">&amp;#39;\n&amp;#39;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
tokenise_lowercase&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e"># Transliterate uppercase to lowercase&lt;/span>
tr A-Z a-z
&lt;span style="color:#f92672">}&lt;/span>
frequencies&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e"># Produce frequency distribution of input&lt;/span>
sort | uniq -c | sort -rn
&lt;span style="color:#f92672">}&lt;/span>
take_n&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e"># Given a number n, return those many lines of input&lt;/span>
&lt;span style="color:#75715e"># or 10 lines by default, if n is not specified.&lt;/span>
sed &lt;span style="color:#e6db74">${&lt;/span>1&lt;span style="color:#66d9ef">:-&lt;/span>10&lt;span style="color:#e6db74">}&lt;/span>q
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And what if we update the pipeline with &lt;em>function calls&lt;/em> like this?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">man bash |
flatten_paragraphs |
tokenise_lowercase |
frequencies |
take_n &lt;span style="color:#ae81ff">10&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Yes, we get the same result!&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-text" data-lang="text">4200 the
1822 is
1251 to
1221 a
1147 of
869 if
805 and
570 shell
570 in
563 command
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Yes, yes, &lt;em>&lt;strong>YES&lt;/strong>&lt;/em>! Functions + pipes = mind blown!&lt;/p>
&lt;h2 id="play-semantics-functions-ooh-what-if-i-dot-dot-dot">Play! Semantics -&amp;gt; Functions -&amp;gt; &amp;ldquo;Ooh, what if I&amp;hellip;&amp;rdquo;&lt;/h2>
&lt;p>Now that we lifted out a couple of text processing functions, we can try to
make &lt;em>more&lt;/em> text processing functions. Here are some examples.&lt;/p>
&lt;p>(Edit 2022-03-10: the &amp;ldquo;clever&amp;rdquo; mkfifo-ery contains dangers I did not know of.
More at the bottom, in the appendix.)&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">sort_dictionary&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
sort -b -d -k2
&lt;span style="color:#f92672">}&lt;/span>
sort_rhyme&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
rev | sort -b -d | rev
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e"># eliminate stop-words&lt;/span>
drop_stopwords&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
local stopwords&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>1&lt;span style="color:#66d9ef">:-&lt;/span>&lt;span style="color:#e6db74">&amp;#34;the,is,to,a,of,if,and,in,or,be,by,not,with,for,when,it&amp;#34;&lt;/span>&lt;span style="color:#e6db74">}&lt;/span>
local grep_pattern&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">$(&lt;/span>tr , &lt;span style="color:#e6db74">&amp;#39;\|&amp;#39;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&amp;lt;&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>stopwords&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#66d9ef">)&lt;/span>
grep -v -E &lt;span style="color:#e6db74">${&lt;/span>grep_pattern&lt;span style="color:#e6db74">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;span style="color:#75715e"># n-grams&lt;/span>
butlast_n&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e"># utility for picking appropriate collection of n-grams&lt;/span>
head -n -&lt;span style="color:#e6db74">${&lt;/span>1&lt;span style="color:#66d9ef">:-&lt;/span>0&lt;span style="color:#e6db74">}&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
bigram&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e"># we need intermediate state, but we can make it stream,&lt;/span>
&lt;span style="color:#75715e"># instead of accumulating in temp files&lt;/span>
mkfifo bigram_buffer
tee &amp;gt;&lt;span style="color:#f92672">(&lt;/span>tail +2 &amp;gt; bigram_buffer&lt;span style="color:#f92672">)&lt;/span> |
paste - bigram_buffer |
&lt;span style="color:#75715e"># take all but the last entry as it is not a bigram&lt;/span>
butlast_n &lt;span style="color:#ae81ff">1&lt;/span>
rm bigram_buffer
&lt;span style="color:#f92672">}&lt;/span>
trigram&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e"># we need intermediate state, but we can make it stream,&lt;/span>
&lt;span style="color:#75715e"># instead of accumulating in temp files&lt;/span>
mkfifo trigram_buffer_one trigram_buffer_two
tee &amp;gt;&lt;span style="color:#f92672">(&lt;/span>tail +2 &amp;gt; trigram_buffer_one&lt;span style="color:#f92672">)&lt;/span> |
tee &amp;gt;&lt;span style="color:#f92672">(&lt;/span>tail +3 &amp;gt; trigram_buffer_two&lt;span style="color:#f92672">)&lt;/span> |
paste - trigram_buffer_one trigram_buffer_two |
&lt;span style="color:#75715e"># take all but the last 2 entries as they are not trigrams&lt;/span>
butlast_n &lt;span style="color:#ae81ff">2&lt;/span>
rm trigram_buffer_one trigram_buffer_two
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Clearly there is a lot to explore about functions and pipelines and other
techniques in this code. We will do deep dives in upcoming posts. For now
just know that Bash functions&amp;hellip;&lt;/p>
&lt;ul>
&lt;li>name a group of shell statements,&lt;/li>
&lt;li>can be composed with pipes&lt;/li>
&lt;li>thus intermix with regular shell tools, and&lt;/li>
&lt;li>can help create domain-specific abstractions out of domain-agnostic ones.&lt;/li>
&lt;/ul>
&lt;p>But before we go there, indulge me and my &lt;em>Oh, and One More Thing (TM)&lt;/em> &amp;hellip;&lt;/p>
&lt;h2 id="compose-again-semantics-functions-play-grand-new-pipeline">Compose Again! Semantics -&amp;gt; Functions -&amp;gt; Play -&amp;gt; Grand New Pipeline&lt;/h2>
&lt;p>What&amp;rsquo;s the point of making a text processing library of functions if we don&amp;rsquo;t
process any text?&lt;/p>
&lt;p>Well&amp;hellip;&lt;/p>
&lt;ul>
&lt;li>Start a new shell session.&lt;/li>
&lt;li>Copy-paste all the Bash functions above into it.&lt;/li>
&lt;li>Then copy-paste this pipeline and&lt;/li>
&lt;li>Hit Enter!&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#75715e"># I assume you have Bash version 4+.&lt;/span>
man bash |
&lt;span style="color:#75715e"># pre-process&lt;/span>
flatten_paragraphs |
tokenise_lowercase |
drop_stopwords |
&lt;span style="color:#75715e"># cache raw pre-processed data, if we need to re-analyse later&lt;/span>
tee /tmp/bash_manpage_raw_tokens.txt |
&lt;span style="color:#75715e"># cache various views or compressions of the raw data&lt;/span>
tee &amp;gt;&lt;span style="color:#f92672">(&lt;/span>sort_dictionary | uniq &amp;gt; /tmp/bash_manpage_sorted_as_dictionary.txt&lt;span style="color:#f92672">)&lt;/span> |
tee &amp;gt;&lt;span style="color:#f92672">(&lt;/span>sort_rhyme | uniq &amp;gt; /tmp/bash_manpage_sorted_as_rhyme.txt&lt;span style="color:#f92672">)&lt;/span> |
&lt;span style="color:#75715e"># accumulate various analyses of the OG raw data&lt;/span>
tee &amp;gt;&lt;span style="color:#f92672">(&lt;/span>frequencies &amp;gt; /tmp/bash_manpage_token_freqs.txt&lt;span style="color:#f92672">)&lt;/span> |
tee &amp;gt;&lt;span style="color:#f92672">(&lt;/span>bigram | frequencies &amp;gt; /tmp/bash_manpage_bigram_freqs.txt&lt;span style="color:#f92672">)&lt;/span> |
tee &amp;gt;&lt;span style="color:#f92672">(&lt;/span>trigram | frequencies &amp;gt; /tmp/bash_manpage_trigram_freqs.txt&lt;span style="color:#f92672">)&lt;/span> |
take_n
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And why not experiment?!&lt;/p>
&lt;p>Reorder it! Remove parts of it! Change parts of it! Give it 10 GiB of input!&lt;/p>
&lt;p>Play and learn!!!&lt;/p>
&lt;p>(#protip: The shell can auto-complete functions. Type &lt;em>flat&lt;/em> and hit &lt;em>TAB&lt;/em>,
and you should get a completion for &lt;em>flatten_paragraphs&lt;/em>.)&lt;/p>
&lt;h2 id="addendum-remarkable-aspects-of-doug-s-o-dot-g-dot-pipeline">Addendum: Remarkable aspects of Doug&amp;rsquo;s O.G. pipeline&lt;/h2>
&lt;p>The UNIX tools philosophy is clearly at work. &lt;code>sort&lt;/code> just sorts, &lt;code>uniq&lt;/code> just
returns uniques, pipes connect parts. Ho hum.&lt;/p>
&lt;p>The things I &lt;em>do&lt;/em> find remarkable are:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Now the year is 2022, i.e. McIlroy wrote the program about 4 &lt;em>decades&lt;/em> ago.
It continues to edify, meaning the ideas it contains have a timeless quality.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;em>It also works as-is&lt;/em>, on my cheap Thinkpad running a GNU Linux (Ubuntu),
even though the original code was written for a UNIX that might live only
in a museum today (or maybe in your bank). Odds look good that come 2036, it
will continue to still work as-is on mainstream boxen.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>It is plain text, and so eminently portable. (I slapped it into the org-mode
file of this blog post, evaluated it via org-babel, and captured the results
inline. How? Because Emacs org-babel can simply &amp;ldquo;shell out&amp;rdquo;; i.e. make a
standard request to a standard shell to evaluate the program and have the
shell process return any result in a standard way.)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>I bet it runs &lt;em>way&lt;/em> faster now because my box is a supercomputer v/s the
UNIX boxen of that era.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Pipes remove the burden of explicit state handling. Oh, also, Douglas McIlroy
invented UNIX pipes.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>The entire composition is itself a function.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>map&lt;/code> (tokenise), &lt;code>filter&lt;/code> (uniquify), &lt;code>reduce&lt;/code> (frequency distribution),
and early termination (&lt;code>take&lt;/code> first 10) are &lt;em>automatic&lt;/em>, needing no special
machinery.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>It is an abstract computation that is independent of data source/sink. We
can hook into any I/O combination of sockets, or fifo pipes, or files on
disk without modifying the pipeline code&amp;mdash;much like Clojure transducers
or monadic I/O in Haskell land.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;em>Most importantly&lt;/em>, a rank amateur like me could figure out each part &lt;em>and&lt;/em>
the whole in one sitting. It is eminently doable because:&lt;/p>
&lt;ul>
&lt;li>each sub part is understandable in isolation &lt;em>and&lt;/em>&lt;/li>
&lt;li>the whole is amenable to incremental as well as large-scale adaptation,&lt;/li>
&lt;li>in playful, interactive, low-risk ways.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>I was clueless then and had to dig through manpages and flail about at the
command line. It took me a while to grok the function of each tool and how
it is applied to the text processing problem.&lt;/p>
&lt;p>If you haven&amp;rsquo;t already, I&amp;rsquo;d say bear that small cost, because it teaches a
priceless lesson in modular, composable, functional architecture.&lt;/p>
&lt;p>Plus, why not step up one&amp;rsquo;s shell-fu?&lt;/p>
&lt;h2 id="appendix-an-unexpected-masterclass">Appendix: an unexpected masterclass!&lt;/h2>
&lt;p>My head is exploding. Prof. McIlroy emailed me some remarks. (There is a
backstory, but first the important stuff.)&lt;/p>
&lt;h3 id="the-danger-lurking-in-the-pipes">The danger lurking in the pipes&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-text" data-lang="text">(Emails redacted to stymie spambots.)
----- Original message -----
From: Douglas McIlroy &amp;lt;Email at his web page. Link posted below.&amp;gt;
To: Aditya Athalye &amp;lt;Email at this web page. See footer.&amp;gt;
Subject: Musings on your blog
Date: Wednesday, March 09, 2022 8:16 PM
Aditya,
A reader might complain that the bigram example in your blog
can be done more efficiently, with a similar amount of typing,
by a sed script instead of mkfifo, tee, and paste:
sed -n &amp;#39;1bx; H; g; s/\n/ /p; s/.* //; :x; h&amp;#39;
A slightly different example is immune to this charge:
trap &amp;#34;rm -f fifo&amp;#34; 0 HUP TERM PIPE INT
mkfifo fifo
sort |
uniq |
tee &amp;gt;(rev | sort &amp;gt;fifo) |
join -o 1.1 - fifo &amp;gt;palindromes
But ... join can&amp;#39;t move until rev|sort produces output, so
essentially the whole word list piles up in its input pipe.
If there&amp;#39;s not enough buffer space, deadlock will occur.
The moral of this tale is that loops in the (undirected)
graph of a pipe network pose a hazard of deadlock if some
pipe queue necessarily suffers unbounded growth. This
hazard manifests in the palindrome example but not in
the bigram example.
Sidelight. Buffering by C&amp;#39;s stdio package can cause
deadlock in a feedback loop. A process that buffers its
output will starve if it needs feedback from stuff that&amp;#39;s
waiting in its output buffer. stdio&amp;#39;s buffering is evil!
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Prof. McIlroy also pointed me to his notes on coroutine-based programs
(examples of stream processing in Unix).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-text" data-lang="text">In case you haven&amp;#39;t already seen it,
https://www.cs.dartmouth.edu/~doug/sieve/sieve.pdf
exhibits some unusual plumbing.
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The PDF is available at &lt;a href="https://www.cs.dartmouth.edu/~doug/">his Dartmouth College home page&lt;/a>,
which has other fun stuff too.&lt;/p>
&lt;h3 id="backstory">Backstory&lt;/h3>
&lt;p>I habitually cold-email people if something they did or said moved me in some
constructive way. So, I wrote a little thank you note to Prof. McIlroy after
posting this blog entry (nobody thinks straight at 3 AM).&lt;/p>
&lt;p>He replied! We exchanged a couple of emails. &lt;em>&amp;ldquo;That was &lt;strong>so cool&lt;/strong>!&amp;quot;&lt;/em> thought I,
and went back to life as usual.&lt;/p>
&lt;p>Yesterday he emailed these follow-up remarks! A nice little masterclass in
Unix programming that I&amp;rsquo;m so pleased to share here, with Prof. McIlroy&amp;rsquo;s
gracious permission.&lt;/p>
&lt;h3 id="postscript">Postscript&lt;/h3>
&lt;p>Wow, this is one of the best emails I&amp;rsquo;ve ever received! The reader&amp;rsquo;s
complaints are warranted and deserved.&lt;/p>
&lt;p>I was fooling around with mkfifo and accidentally discovered it &amp;ldquo;worked&amp;rdquo;
after a fashion. &amp;ldquo;What&amp;rsquo;s the buffering story?&amp;rdquo; crossed my mind, but I didn&amp;rsquo;t
find out. I&amp;rsquo;m also slapping my forehead for not using &lt;code>trap&lt;/code> to auto-clean
the pipes. And needless to say, &lt;a href="https://github.com/adityaathalye/shite/blob/5f87aa0df095a1b5af914117aaa34bf63c67ec4d/shite%5Futils.sh#L155">my sed-fu&lt;/a> is weak. Brown belt at best :)&lt;/p>
&lt;p>I rue the fact that I haven&amp;rsquo;t paid due attention to The Machine. I can write
Clojure to make a living, but can&amp;rsquo;t write C to save my life :))&lt;/p>
&lt;p>So now this excellent complaint leaves me no choice, but to crack open my
long-unused copies of the K&amp;amp;R book and The Unix Programming Environment.&lt;/p>
&lt;p>&lt;em>Thank you so much for taking the time to teach me, Professor!&lt;/em>&lt;/p>
&lt;hr>
&lt;p>Next up: Part 2/N: Deep-dive into bash functions and function design techniques&lt;/p>
&lt;ul>
&lt;li>Using functions to craft one’s own Bytes-sized UNIX tools&lt;/li>
&lt;li>Using them interactively like regular UNIX tools&lt;/li>
&lt;li>maybe more&amp;hellip;&lt;/li>
&lt;/ul>
&lt;p>The ol' noodle is noodlin' over it. Stay tooned!&lt;/p></content></item><item><title>Dismal Arithmetic in Dyalog APL and Clojure</title><link>/posts/dismal-arithmetic-dyalog-apl-clojure/</link><pubDate>Fri, 25 Feb 2022 16:29:33 +0530</pubDate><guid>/posts/dismal-arithmetic-dyalog-apl-clojure/</guid><description>&lt;p>Throwback: Jan 2018.&lt;/p>
&lt;p>I learned of something called &lt;em>&lt;a href="https://arxiv.org/abs/1107.1130">Dismal Arithmetic&lt;/a>&lt;/em>. As the linked paper describes it:&lt;/p>
&lt;blockquote>
&lt;p>Dismal arithmetic is just like the arithmetic you learned in school, only
simpler: there are no carries, when you add digits you just take the largest,
and when you multiply digits you take the smallest. This paper studies basic
number theory in this world, including analogues of the primes, number of
divisors, sum of divisors, and the partition function.&lt;/p>
&lt;/blockquote>
&lt;p>I thought it might be fun to implement it in APL for kicks, but I wrote it in
Clojure first, because I wasn&amp;rsquo;t sure of my APL-fu. And I&amp;rsquo;m glad I wrote the
Dyalog APL version because I learned something about trains, and also because
I stumbled on the idea of &amp;ldquo;inverse of a function&amp;rdquo; which melted my mind a bit.&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;ul>
&lt;li>&lt;a href="#examples-of-dismal-addition-and-multiplication">Examples of Dismal Addition and Multiplication&lt;/a>&lt;/li>
&lt;li>&lt;a href="#dismal-arithmetic-in-clojure">Dismal Arithmetic in Clojure&lt;/a>&lt;/li>
&lt;li>&lt;a href="#dismal-arithmetic-in-dyalog-apl">Dismal Arithmetic in Dyalog APL&lt;/a>&lt;/li>
&lt;li>&lt;a href="#addendum-the-of-inverse">Addendum: The ⍣ of inverse&lt;/a>&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted --></description><content>&lt;p>Throwback: Jan 2018.&lt;/p>
&lt;p>I learned of something called &lt;em>&lt;a href="https://arxiv.org/abs/1107.1130">Dismal Arithmetic&lt;/a>&lt;/em>. As the linked paper describes it:&lt;/p>
&lt;blockquote>
&lt;p>Dismal arithmetic is just like the arithmetic you learned in school, only
simpler: there are no carries, when you add digits you just take the largest,
and when you multiply digits you take the smallest. This paper studies basic
number theory in this world, including analogues of the primes, number of
divisors, sum of divisors, and the partition function.&lt;/p>
&lt;/blockquote>
&lt;p>I thought it might be fun to implement it in APL for kicks, but I wrote it in
Clojure first, because I wasn&amp;rsquo;t sure of my APL-fu. And I&amp;rsquo;m glad I wrote the
Dyalog APL version because I learned something about trains, and also because
I stumbled on the idea of &amp;ldquo;inverse of a function&amp;rdquo; which melted my mind a bit.&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;ul>
&lt;li>&lt;a href="#examples-of-dismal-addition-and-multiplication">Examples of Dismal Addition and Multiplication&lt;/a>&lt;/li>
&lt;li>&lt;a href="#dismal-arithmetic-in-clojure">Dismal Arithmetic in Clojure&lt;/a>&lt;/li>
&lt;li>&lt;a href="#dismal-arithmetic-in-dyalog-apl">Dismal Arithmetic in Dyalog APL&lt;/a>&lt;/li>
&lt;li>&lt;a href="#addendum-the-of-inverse">Addendum: The ⍣ of inverse&lt;/a>&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;hr>
&lt;h2 id="examples-of-dismal-addition-and-multiplication">Examples of Dismal Addition and Multiplication&lt;/h2>
&lt;p>OK, so first, a disclaimer. The code doesn&amp;rsquo;t explore all of the paper, just
addition, multiplication along with commutative, associative, distributive
properties thereof, because that&amp;rsquo;s all the Mathematics I understand :) I had
fun struggling through the paper anyway mainly because of the funny name.
(More papers should have more wryness and less dryness.)&lt;/p>
&lt;p>Anyway, the rules of the game are:&lt;/p>
&lt;ul>
&lt;li>arithmetic as in school, except that&lt;/li>
&lt;li>there there are no carries,&lt;/li>
&lt;li>when you add digits you just take the largest,&lt;/li>
&lt;li>and when you multiply digits you take the smallest&lt;/li>
&lt;/ul>
&lt;p>Dismal addition: 169 + 248 = 269, because&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-text" data-lang="text"> 1 6 9
+ 2 4 8
-------
2 6 9
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Dismal Multiplication: 169 * 248 = 12468, because&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-text" data-lang="text"> 1 6 9
x 2 4 8
---------
1 6 8
1 4 4
1 2 2
---------
1 2 4 6 8
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The tasks:&lt;/p>
&lt;ul>
&lt;li>Write function for dismal addition
&lt;ul>
&lt;li>Takes two positive integer returns dismal sum&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Write function for dismal multiplication
&lt;ul>
&lt;li>Takes two positive integer returns dismal multiplication&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="dismal-arithmetic-in-clojure">Dismal Arithmetic in Clojure&lt;/h2>
&lt;p>Here I explored the basic properties of addition and multiplication. Yeah,
sorry got to slog through some encoding/decoding prerequisites first.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-clojure" data-lang="clojure">(&lt;span style="color:#66d9ef">ns &lt;/span>dismal-arithmetic)
(&lt;span style="color:#66d9ef">defn &lt;/span>n-&amp;gt;digits
&lt;span style="color:#e6db74">&amp;#34;Really dismal :sobbing:
&lt;/span>&lt;span style="color:#e6db74"> Will turn the number 12345 into the sequence (1 2 3 4 5).&amp;#34;&lt;/span>
[n]
(&lt;span style="color:#66d9ef">loop &lt;/span>[n n
xs (&lt;span style="color:#a6e22e">list&lt;/span>)]
(&lt;span style="color:#66d9ef">if &lt;/span>(&amp;lt; n &lt;span style="color:#ae81ff">10&lt;/span>) &lt;span style="color:#75715e">; ensure we split 10 also, into 1 and 0&lt;/span>
(conj xs (-&amp;gt; n Math/floor Math/round))
(&lt;span style="color:#a6e22e">recur&lt;/span> (/ n &lt;span style="color:#ae81ff">10&lt;/span>)
(conj xs
(-&amp;gt; n (rem &lt;span style="color:#ae81ff">10&lt;/span>) Math/floor Math/round))))))
&lt;span style="color:#75715e">;; Check...&lt;/span>
&lt;span style="color:#f92672">#&lt;/span>_(map n-&amp;gt;digits [&lt;span style="color:#ae81ff">169&lt;/span> &lt;span style="color:#ae81ff">248&lt;/span> &lt;span style="color:#ae81ff">100&lt;/span> &lt;span style="color:#ae81ff">10&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>])
(&lt;span style="color:#66d9ef">defn &lt;/span>digits-&amp;gt;n
&lt;span style="color:#e6db74">&amp;#34;Will turn the sequence (1 2 3 4 5) into the number 12345.&amp;#34;&lt;/span>
[dxs]
(reduce (&lt;span style="color:#66d9ef">fn &lt;/span>[r dx] (+ (* r &lt;span style="color:#ae81ff">10&lt;/span>) dx))
dxs))
(&lt;span style="color:#66d9ef">defn &lt;/span>dismal-add
&lt;span style="color:#e6db74">&amp;#34;x and y can have any number of digits&amp;#34;&lt;/span>
[x y]
(&lt;span style="color:#66d9ef">let &lt;/span>[nxs (&lt;span style="color:#a6e22e">n-&amp;gt;digits&lt;/span> x)
nys (&lt;span style="color:#a6e22e">n-&amp;gt;digits&lt;/span> y)
cxs (count nxs)
cys (count nys)
dxys (&lt;span style="color:#a6e22e">Math/abs&lt;/span> (- cxs cys))
dzs (repeat dxys &lt;span style="color:#ae81ff">0&lt;/span>)
[nxs nys] (&lt;span style="color:#66d9ef">if &lt;/span>(&amp;gt; cxs cys)
[nxs (concat dzs nys)]
[(concat dzs nxs) nys])]
(&lt;span style="color:#a6e22e">-&amp;gt;&amp;gt;&lt;/span> nys
(map max nxs)
digits-&amp;gt;n)))
(&lt;span style="color:#66d9ef">defn &lt;/span>dismal-mul
&lt;span style="color:#e6db74">&amp;#34;Like politics and war, multiplication is just addition
&lt;/span>&lt;span style="color:#e6db74"> by other means. No?&amp;#34;&lt;/span>
[x y]
(&lt;span style="color:#66d9ef">let &lt;/span>[nxs (&lt;span style="color:#a6e22e">n-&amp;gt;digits&lt;/span> x)
nys (&lt;span style="color:#a6e22e">n-&amp;gt;digits&lt;/span> y)
diagonal-summable
(reduce (&lt;span style="color:#66d9ef">fn &lt;/span>[rs y]
(conj rs (map &lt;span style="color:#f92672">#&lt;/span>(min y %) nys)))
[]
nxs)
transpose-matrix (&lt;span style="color:#66d9ef">fn &lt;/span>[matrix]
(into []
(apply map vector matrix)))
summable-matrix (&lt;span style="color:#a6e22e">transpose-matrix&lt;/span> diagonal-summable)
summables (reverse (map digits-&amp;gt;n summable-matrix))
summables (&lt;span style="color:#a6e22e">map-indexed&lt;/span> (&lt;span style="color:#66d9ef">fn &lt;/span>[idx x]
(* x (&lt;span style="color:#a6e22e">Math/round&lt;/span> (&lt;span style="color:#a6e22e">Math/pow&lt;/span> &lt;span style="color:#ae81ff">10&lt;/span> idx))))
summables)]
(reduce dismal-add summables)))
(&lt;span style="color:#a6e22e">comment&lt;/span>
&lt;span style="color:#75715e">;; Given test cases:&lt;/span>
(= (&lt;span style="color:#a6e22e">dismal-add&lt;/span> &lt;span style="color:#ae81ff">169&lt;/span> &lt;span style="color:#ae81ff">248&lt;/span>)
&lt;span style="color:#ae81ff">269&lt;/span>)
(= (&lt;span style="color:#a6e22e">dismal-mul&lt;/span> &lt;span style="color:#ae81ff">169&lt;/span> &lt;span style="color:#ae81ff">248&lt;/span>)
&lt;span style="color:#ae81ff">12468&lt;/span>)
&lt;span style="color:#75715e">;; Other numbers:&lt;/span>
(&lt;span style="color:#a6e22e">dismal-add&lt;/span> &lt;span style="color:#ae81ff">123&lt;/span> &lt;span style="color:#ae81ff">45678&lt;/span>)
(&lt;span style="color:#a6e22e">dismal-mul&lt;/span> &lt;span style="color:#ae81ff">123&lt;/span> &lt;span style="color:#ae81ff">45678&lt;/span>)
&lt;span style="color:#75715e">;; Associative?&lt;/span>
(= (&lt;span style="color:#a6e22e">dismal-add&lt;/span> &lt;span style="color:#ae81ff">169&lt;/span> (&lt;span style="color:#a6e22e">dismal-add&lt;/span> &lt;span style="color:#ae81ff">248&lt;/span> &lt;span style="color:#ae81ff">100&lt;/span>))
(&lt;span style="color:#a6e22e">dismal-add&lt;/span> (&lt;span style="color:#a6e22e">dismal-add&lt;/span> &lt;span style="color:#ae81ff">169&lt;/span> &lt;span style="color:#ae81ff">248&lt;/span>) &lt;span style="color:#ae81ff">100&lt;/span>))
(= (&lt;span style="color:#a6e22e">dismal-mul&lt;/span> &lt;span style="color:#ae81ff">169&lt;/span> (&lt;span style="color:#a6e22e">dismal-mul&lt;/span> &lt;span style="color:#ae81ff">248&lt;/span> &lt;span style="color:#ae81ff">100&lt;/span>))
(&lt;span style="color:#a6e22e">dismal-mul&lt;/span> (&lt;span style="color:#a6e22e">dismal-mul&lt;/span> &lt;span style="color:#ae81ff">169&lt;/span> &lt;span style="color:#ae81ff">248&lt;/span>) &lt;span style="color:#ae81ff">100&lt;/span>))
&lt;span style="color:#75715e">;; Commutative?&lt;/span>
(= (reduce dismal-add [&lt;span style="color:#ae81ff">169&lt;/span> &lt;span style="color:#ae81ff">248&lt;/span> &lt;span style="color:#ae81ff">12345&lt;/span>])
(reduce dismal-add [&lt;span style="color:#ae81ff">248&lt;/span> &lt;span style="color:#ae81ff">12345&lt;/span> &lt;span style="color:#ae81ff">169&lt;/span>])
(reduce dismal-add [&lt;span style="color:#ae81ff">12345&lt;/span> &lt;span style="color:#ae81ff">169&lt;/span> &lt;span style="color:#ae81ff">248&lt;/span>]))
(= (reduce dismal-mul [&lt;span style="color:#ae81ff">169&lt;/span> &lt;span style="color:#ae81ff">248&lt;/span> &lt;span style="color:#ae81ff">12345&lt;/span>])
(reduce dismal-mul [&lt;span style="color:#ae81ff">248&lt;/span> &lt;span style="color:#ae81ff">12345&lt;/span> &lt;span style="color:#ae81ff">169&lt;/span>])
(reduce dismal-mul [&lt;span style="color:#ae81ff">12345&lt;/span> &lt;span style="color:#ae81ff">169&lt;/span> &lt;span style="color:#ae81ff">248&lt;/span>]))
&lt;span style="color:#75715e">;; Distributive?&lt;/span>
(= (&lt;span style="color:#a6e22e">dismal-mul&lt;/span> &lt;span style="color:#ae81ff">100&lt;/span>
(&lt;span style="color:#a6e22e">dismal-add&lt;/span> &lt;span style="color:#ae81ff">169&lt;/span> &lt;span style="color:#ae81ff">248&lt;/span>))
(&lt;span style="color:#a6e22e">dismal-add&lt;/span> (&lt;span style="color:#a6e22e">dismal-mul&lt;/span> &lt;span style="color:#ae81ff">100&lt;/span> &lt;span style="color:#ae81ff">169&lt;/span>)
(&lt;span style="color:#a6e22e">dismal-mul&lt;/span> &lt;span style="color:#ae81ff">100&lt;/span> &lt;span style="color:#ae81ff">248&lt;/span>)))
)
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="dismal-arithmetic-in-dyalog-apl">Dismal Arithmetic in Dyalog APL&lt;/h2>
&lt;p>Here, I managed to implement addition, discovered how to write &amp;ldquo;inverse of a
function&amp;rdquo; and my mind melted.&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-dyalog" data-lang="dyalog"> da ← 10⊥(⌈/10⊥⍣¯1⊢)
da 169 248
269
&lt;/code>&lt;/pre>&lt;p>Yes, that&amp;rsquo;s the entire solution to dismal addition. &lt;code>⍣¯1&lt;/code> is APL for &amp;ldquo;inverse&amp;rdquo;.
Here is the solution explained in parts. I first did it with dfns, because my
brain is stuck inside Lisp / traditional functional programming style.&lt;/p>
&lt;p>Apart from built-in support for numeric encoding/decoding, notice the automatic
zero-padding.&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-dyalog" data-lang="dyalog"> {10(⊤⍣¯1)⍵}∘{⌈/⍵}∘{10(⊥⍣¯1)⍵}⊢ 100000 10000 1000 100 10 1
111111
{10(⊤⍣¯1)⍵}∘{⌈/⍵}∘{10(⊥⍣¯1)⍵}⊢ 1 10 100 1000 10000 100000
111111
da ← 10⊥(⌈/10⊥⍣¯1⊢)
da 1 10 100 1000 10000 100000
111111
&lt;/code>&lt;/pre>&lt;p>&lt;em>However&lt;/em>, there is something deeply unsatisfying about using dfns in APL, when
you know trains exist.&lt;/p>
&lt;p>So I muddled about and managed to express the whole idea as a single unit, viz.
this lovely little expression &lt;code>10⊥(⌈/10⊥⍣¯1⊢)&lt;/code> which says &amp;ldquo;Dismal Arithmetic&amp;rdquo;
in fewer characters than the name &lt;em>and is also&lt;/em> a working partial implementation.
Here is how it breaks down in my FP-addled brain:&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-dyalog" data-lang="dyalog">decode ← 10(⊥⍣¯1)⊢
reducemax ← ⌈/
encode ← 10(⊤⍣¯1)⊢
encode reducemax decode 169 248
269
&lt;/code>&lt;/pre>&lt;h2 id="addendum-the-of-inverse">Addendum: The ⍣ of inverse&lt;/h2>
&lt;p>Aaaron Hsu helped me understand what was going on, and wrote about
&amp;ldquo;&lt;a href="https://www.sacrideo.us/decoding-inverses/">Decoding Inverses&lt;/a>&amp;rdquo; at his blog.&lt;/p></content></item><item><title>Shell ain't a bad place to FP: part 0/N</title><link>/posts/shell-aint-a-bad-place-to-fp-part-0-intro/</link><pubDate>Wed, 23 Feb 2022 01:55:11 +0530</pubDate><guid>/posts/shell-aint-a-bad-place-to-fp-part-0-intro/</guid><description>&lt;p>Or, &lt;em>&lt;strong>Supremely Functional Bash Programming&lt;/strong>, an exploration in N parts&amp;hellip;&lt;/em>&lt;/p>
&lt;p>Once upon a time, while fiddling with a log processing shell pipeline, it hit me
that the UNIX Way is a Surprisingly Functional Way, and so Functional Programming
(FP) and Bash must be a natural fit. They fit. The world was never the same again.&lt;/p>
&lt;p>Now I believe it so much, that I will go on a limb and assert that it is
highly inappropriate to write imperative-style Bash when we can just as easily
write &lt;em>supremely&lt;/em> functional Bash. Why? Because it makes for supremely &lt;em>better&lt;/em>
Bash (more reusable, more composable, more scalable, more enjoyable).&lt;/p>
&lt;p>Yes, I truly believe.&lt;/p>
&lt;p>Yes, I&amp;rsquo;m sane.&lt;/p>
&lt;p>No? Well OK, humour me&amp;hellip;&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;ul>
&lt;li>&lt;a href="#obligatory-mea-culpa">Obligatory mea culpa&lt;/a>&lt;/li>
&lt;li>&lt;a href="#an-outline-of-the-n-parts">An outline of the &amp;ldquo;N&amp;rdquo; parts&lt;/a>&lt;/li>
&lt;li>&lt;a href="#prelude-seeing-the-unix-tools-philosophy-as-a-functional-design-philosophy">Prelude: Seeing the UNIX tools philosophy as a functional design philosophy&lt;/a>&lt;/li>
&lt;li>&lt;a href="#screw-that-show-me-your-code">&amp;ldquo;Screw that, show me your code&amp;rdquo;&lt;/a>&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted --></description><content>&lt;p>Or, &lt;em>&lt;strong>Supremely Functional Bash Programming&lt;/strong>, an exploration in N parts&amp;hellip;&lt;/em>&lt;/p>
&lt;p>Once upon a time, while fiddling with a log processing shell pipeline, it hit me
that the UNIX Way is a Surprisingly Functional Way, and so Functional Programming
(FP) and Bash must be a natural fit. They fit. The world was never the same again.&lt;/p>
&lt;p>Now I believe it so much, that I will go on a limb and assert that it is
highly inappropriate to write imperative-style Bash when we can just as easily
write &lt;em>supremely&lt;/em> functional Bash. Why? Because it makes for supremely &lt;em>better&lt;/em>
Bash (more reusable, more composable, more scalable, more enjoyable).&lt;/p>
&lt;p>Yes, I truly believe.&lt;/p>
&lt;p>Yes, I&amp;rsquo;m sane.&lt;/p>
&lt;p>No? Well OK, humour me&amp;hellip;&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;ul>
&lt;li>&lt;a href="#obligatory-mea-culpa">Obligatory mea culpa&lt;/a>&lt;/li>
&lt;li>&lt;a href="#an-outline-of-the-n-parts">An outline of the &amp;ldquo;N&amp;rdquo; parts&lt;/a>&lt;/li>
&lt;li>&lt;a href="#prelude-seeing-the-unix-tools-philosophy-as-a-functional-design-philosophy">Prelude: Seeing the UNIX tools philosophy as a functional design philosophy&lt;/a>&lt;/li>
&lt;li>&lt;a href="#screw-that-show-me-your-code">&amp;ldquo;Screw that, show me your code&amp;rdquo;&lt;/a>&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;hr>
&lt;h2 id="obligatory-mea-culpa">Obligatory mea culpa&lt;/h2>
&lt;p>Because I&amp;rsquo;m am going to lazy-stream this in N parts. Because my original post
was growing to &amp;ldquo;never gonna ship&amp;rdquo; size. But &lt;em>&lt;strong>not&lt;/strong>&lt;/em> because &amp;ldquo;Bash ain&amp;rsquo;t a &lt;em>real&lt;/em>
programming language&amp;rdquo;. (Besides, in our post-reality world, we get to make
our own reality.)&lt;/p>
&lt;h3 id="nothing-here-will-be-novel-dot">Nothing here will be novel.&lt;/h3>
&lt;ul>
&lt;li>&lt;em>&lt;strong>I&amp;rsquo;ve not invented anything that follows.&lt;/strong>&lt;/em> There are too many influences to
enumerate fully. I&amp;rsquo;ll provide references as I go along.&lt;/li>
&lt;li>&lt;em>&lt;strong>I expect to revise&lt;/strong>&lt;/em>, correct, add to this series as I learn more over time.&lt;/li>
&lt;li>&lt;em>&lt;strong>Code in the post assumes Bash 4+&lt;/strong>&lt;/em>, because that&amp;rsquo;s what I&amp;rsquo;ve been using
over the last 8-odd years.&lt;/li>
&lt;/ul>
&lt;h3 id="your-mileage-may-vary-dot">Your Mileage May Vary.&lt;/h3>
&lt;ul>
&lt;li>&lt;em>&lt;strong>The Bash code will be both message and medium.&lt;/strong>&lt;/em> but I will describe
general FP thinking, and Bash sure isn&amp;rsquo;t the only medium. Please replicate
solutions in your favourite language (in a UNIX-like way)!&lt;/li>
&lt;li>&lt;em>&lt;strong>I won&amp;rsquo;t go crazy with Bash-isms&lt;/strong>&lt;/em>, so the ideas and most of the code should
generalise to most UNIXy shells. That said, I haven&amp;rsquo;t used other shells to
make equally confident claims about FP in them.&lt;/li>
&lt;/ul>
&lt;h3 id="fp-suffuses-my-very-being-dot-m">&lt;strong>FP &lt;a href="http://evalapply.org/posts/what-makes-functional-programming-systems-functional/">suffuses my very being&lt;/a>.&lt;/strong> \m/&lt;/h3>
&lt;ul>
&lt;li>And I&amp;rsquo;m fairly confident the FP ideas will translate broadly, because I use
them all the time; in my code (Clojure, APL, Ruby, JS, Python, SML&amp;hellip;), in
my designs for logging systems, infra-as-code systems, CI/CD systems, as
well as designing human/communication workflows for teams.&lt;/li>
&lt;li>But it&amp;rsquo;s possible I&amp;rsquo;ve lived my life all wrong.&lt;/li>
&lt;/ul>
&lt;h2 id="an-outline-of-the-n-parts">An outline of the &amp;ldquo;N&amp;rdquo; parts&lt;/h2>
&lt;p>This (zeroth) post is about why the UNIX Way is the way of functional-style
design &lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>. &lt;em>&lt;code>N&lt;/code>&lt;/em> more posts are brewing, with examples and techniques.
Likely one per topic:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>A &lt;em>rad&lt;/em> example from 1986 to motivate the rest of the series.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Deep-dive into bash functions and function design techniques&lt;/p>
&lt;ul>
&lt;li>Using functions to craft one&amp;rsquo;s own Bytes-sized UNIX tools&lt;/li>
&lt;li>Using them interactively like regular UNIX tools&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Pipelining all the things&lt;/p>
&lt;ul>
&lt;li>How we automatically get map / filter / reduce / early termination&lt;/li>
&lt;li>Automatic streaming (regular pipes, tee, named pipes etc&amp;hellip;)&lt;/li>
&lt;li>Ways to do pipeline-friendly domain design, and to translate that into
pipeline-friendly functions.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Avoiding manual state management with intelligent use of:&lt;/p>
&lt;ul>
&lt;li>Variables, scopes, program invariants&lt;/li>
&lt;li>Command substitution&lt;/li>
&lt;li>Process substitution&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Declarative programming&lt;/p>
&lt;ul>
&lt;li>Templating with heredocs and herestrings&lt;/li>
&lt;li>Trickshots with things like &lt;code>seq&lt;/code>, &lt;code>paste&lt;/code> etc.&lt;/li>
&lt;li>Reasonable uses of pattern matching&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Environment isolation in detail&lt;/p>
&lt;ul>
&lt;li>Lists and sub-shells&lt;/li>
&lt;li>in Pipelines&lt;/li>
&lt;li>Session portability&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Designing idempotent / restart-friendly solutions&lt;/p>
&lt;ul>
&lt;li>Because things can and will fail.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Maybe parallelism&lt;/p>
&lt;ul>
&lt;li>Mainly because I haven&amp;rsquo;t &lt;em>had to&lt;/em> &lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup> write parallel Bash, but it will
be fun to mess with.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Maybe sundry topics like associative arrays (Bash-only), job control,
namespacing, metaprogramming, flame-bait like &amp;ldquo;pipes are monads&amp;rdquo; etc.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="prelude-seeing-the-unix-tools-philosophy-as-a-functional-design-philosophy">Prelude: Seeing the UNIX tools philosophy as a functional design philosophy&lt;/h2>
&lt;p>The many remarkable aspects of UNIX Nature were discovered over half a century
worth of versions, revisions, disasters, and reincarnations. While many avatars
of UNICES and UNIX-likes have come and gone, the UNIX Way (articulated by the
1990s) has thrived through the ravages of time. Here it is, embodied in the
form of the UNIX Tools Philosophy.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;em>&lt;strong>Most importantly, do one thing&lt;/strong>&lt;/em>, and do it well (just like a function).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Consume and emit &lt;em>&lt;strong>plain data&lt;/strong>&lt;/em> (just like a function).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;em>&lt;strong>Output the same data format as is received at input&lt;/strong>&lt;/em> (formerly only plain
lines of text, but now also structured literal data like JSON, EDN etc.)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;em>&lt;strong>Don&amp;rsquo;t be chatty&lt;/strong>&lt;/em> (i.e. avoid side-effects, again, just like a function).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Be line-oriented, which design choice turns out to be &lt;em>&lt;strong>naturally streaming&lt;/strong>&lt;/em>,
with &lt;em>&lt;strong>automatic support for map/filter/reduce&lt;/strong>&lt;/em>, which we will use a lot.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Favour &lt;em>&lt;strong>universal composition&lt;/strong>&lt;/em> via standard interfaces like file descriptors,
standard IN/OUT/ERROR, line-orientation, and UNIX pipes (quite monadic, an
argument for much later).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Be as &lt;em>&lt;strong>general-purpose&lt;/strong>&lt;/em> as possible for wide reusability, in any context.
This pushes tools away from imposing internal structure on input data, as
also from maintaining persistent or shared internal state.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Ideally have sane behaviour like environment isolation, idempotence, etc.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Last but not least, when out-of-the-box solutions are not good enough, it
encourages us to detour to building our own tools. And these can be simple
Bash functions, usable interactively at the command line, just like full
standalone programs!&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>Of course, practice can diverge from the ideal, but not by too much (many tools
have to work with stateful objects like files and sockets, some may rely on
lock-files, some should be idempotent but aren&amp;rsquo;t, others may grow to do more
than one thing and do everything badly etc.). Besides, not even Haskellers
escape this reality, so there.&lt;/p>
&lt;p>It stands that the UNIX Way strongly encourages us to create laser-focused,
composable, purely functional, data-flow oriented programs that we can remix
at will into surprisingly powerful solutions with surprisingly little ceremony.&lt;/p>
&lt;p>This &lt;em>Way&lt;/em> has proven to be very useful at scales several orders of magnitude
apart; from in-program 1-liner functions, to 1 kilobyte tools, to operating
systems, to planet-wide distributed systems. This unreasonable effectiveness
is why UNIX People have long valued these values.&lt;/p>
&lt;h2 id="screw-that-show-me-your-code">&amp;ldquo;Screw that, show me your code&amp;rdquo;&lt;/h2>
&lt;p>Sorry! I feel ya&amp;hellip; no code, no dice. Here is some of my FP-style Bash.
I plan to crib liberally from these to illustrate the posts-to-come.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>&lt;a href="https://github.com/adityaathalye/bash-toolkit">bash-toolkit&lt;/a>&lt;/strong>:
a &amp;ldquo;Swiss Army Toolkit&amp;rdquo; of functions I&amp;rsquo;ve been accumulating over the years.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;a href="https://github.com/adityaathalye/oxo">oxo&lt;/a>&lt;/strong>:
a retro-style noughts and crosses game in Bash (and it speaks!).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Next up: &lt;strong>&lt;a href="https://evalapply.org/posts/shell-aint-a-bad-place-to-fp-part-1-doug-mcilroys-pipeline/">Shell ain&amp;rsquo;t a bad place to FP: part 1/N&lt;/a>&lt;/strong>
in which we take apart Douglas McIlroy&amp;rsquo;s famous pipeline from 1986, to
motivate the rest of the series. &amp;ldquo;Take apart&amp;rdquo; in the sense of &amp;ldquo;Design is
about taking things apart.&amp;rdquo;. A most respectful sense.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>May the Source be with us.&lt;/p>
&lt;section class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1" role="doc-endnote">
&lt;p>Recently I went on for a bit in general about &lt;a href="https://www.evalapply.org/posts/what-makes-functional-programming-systems-functional/">what does it even mean to be &amp;ldquo;functional&amp;rdquo;?&lt;/a> Read that if it pleases you, because it informs my approach to &lt;em>Supremely Functional&lt;/em> Bash programming.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:2" role="doc-endnote">
&lt;p>There was the one time I could have, at a $DAYJOB, but I was quite green, and had deadline, and it was a one time log analysis thing, and I a large EC2 box to waste, which I hogged for half a day, and came away stunned that my crappy shell pipeline chewed through ~600 GiB (gzipped) without crashing anything.&amp;#160;&lt;a href="#fnref:2" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/section></content></item><item><title>What makes Functional Programs and Systems "Functional"?</title><link>/posts/what-makes-functional-programming-systems-functional/</link><pubDate>Tue, 22 Feb 2022 15:36:52 +0530</pubDate><guid>/posts/what-makes-functional-programming-systems-functional/</guid><description>&lt;p>In which we ponder the Functional Nature of Life, The Universe, and Everything.
Please feel free to follow through the weeds, or jump straight to the bottom
for my 2 nano BTC on the matter. (Or my current state of mind, at any rate.)&lt;/p>
&lt;p>Disclaimer: I live in the Land of Lisp, meditate in the Church of Alonzo, and
am ever-wary of The State. Only converts &lt;em>might&lt;/em> find some entertainment value.&lt;/p>
&lt;blockquote>
&lt;p>&lt;em>&amp;ldquo;For the love of State is the root of all evil: which while some coveted after,&lt;/em>
&lt;em>they have erred from Lambda the Ultimate, and pierced themselves through with&lt;/em>
&lt;em>many sorrows.&amp;quot;&lt;/em>&lt;/p>
&lt;/blockquote>
&lt;!-- raw HTML omitted -->
&lt;ul>
&lt;li>&lt;a href="#is-it-already-suffusing-your-very-being">Is it already suffusing your very being?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#is-it-mathematics">Is it Mathematics?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#is-it-being-declarative">Is it being &amp;ldquo;declarative&amp;rdquo;?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#is-it-being-data-oriented">Is it being &amp;ldquo;data-oriented&amp;rdquo;?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#is-it-about-statelessness">Is it about &amp;ldquo;Statelessness&amp;rdquo;?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#is-it-about-managed-environments">Is it about &amp;ldquo;managed&amp;rdquo; environments?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#is-it-about-following-some-discipline-and-maybe-automating-it">Is it about following some discipline, and maybe automating it?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#my-2-nano-btc-on-the-matter">My 2 nano BTC on the matter&lt;/a>&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted --></description><content>&lt;p>In which we ponder the Functional Nature of Life, The Universe, and Everything.
Please feel free to follow through the weeds, or jump straight to the bottom
for my 2 nano BTC on the matter. (Or my current state of mind, at any rate.)&lt;/p>
&lt;p>Disclaimer: I live in the Land of Lisp, meditate in the Church of Alonzo, and
am ever-wary of The State. Only converts &lt;em>might&lt;/em> find some entertainment value.&lt;/p>
&lt;blockquote>
&lt;p>&lt;em>&amp;ldquo;For the love of State is the root of all evil: which while some coveted after,&lt;/em>
&lt;em>they have erred from Lambda the Ultimate, and pierced themselves through with&lt;/em>
&lt;em>many sorrows.&amp;quot;&lt;/em>&lt;/p>
&lt;/blockquote>
&lt;!-- raw HTML omitted -->
&lt;ul>
&lt;li>&lt;a href="#is-it-already-suffusing-your-very-being">Is it already suffusing your very being?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#is-it-mathematics">Is it Mathematics?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#is-it-being-declarative">Is it being &amp;ldquo;declarative&amp;rdquo;?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#is-it-being-data-oriented">Is it being &amp;ldquo;data-oriented&amp;rdquo;?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#is-it-about-statelessness">Is it about &amp;ldquo;Statelessness&amp;rdquo;?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#is-it-about-managed-environments">Is it about &amp;ldquo;managed&amp;rdquo; environments?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#is-it-about-following-some-discipline-and-maybe-automating-it">Is it about following some discipline, and maybe automating it?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#my-2-nano-btc-on-the-matter">My 2 nano BTC on the matter&lt;/a>&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;hr>
&lt;h2 id="is-it-already-suffusing-your-very-being">Is it already suffusing your very being?&lt;/h2>
&lt;p>Because so-called &amp;ldquo;Functional Programming&amp;rdquo; started becoming pretty sexy over
the 2010s. By the 2020s, it started infiltrating all the things, small and big
and hyperscaled.&lt;/p>
&lt;p>Now you can&amp;rsquo;t get people to shut up about their declarative infrastructure-as-code
as-YAML microservices-first infinitely elastic shared-nothing event-sourced
map-reducing lambda architecture marvels.&lt;/p>
&lt;p>Now your VCs and your board nod sagely when these words flash past in your slick
OKR plan vision strategy slide decks. Now they further &lt;em>&amp;ldquo;Hey, quick question&amp;rdquo;&lt;/em>
you to same-page on your strategy for blockchain and smart contracts. And
general web3 readiness. So does every novice hire it seems, no matter their role.&lt;/p>
&lt;p>Now&amp;mdash;and be honest, OK?&amp;mdash;don&amp;rsquo;t you feel like everybody should just mentally
lie down for a few minutes in their metaverse, pass around the meta-ayahuasca,
and after the purge just ask simple meta-questions about FP and life for a
change? Because, for the love of lambda, we haven&amp;rsquo;t even gotten a breather
from the fast-nearing AI supremacy?&lt;/p>
&lt;p>No? OK, consider the following incomplete list of traits commonly attributed
to the &amp;ldquo;Functional&amp;rdquo; paradigm of programming languages and of systems. Alongside,
consider:&lt;/p>
&lt;ul>
&lt;li>Which traits does your pet programming language (or system) provide by default?&lt;/li>
&lt;li>Which traits do you create yourself in your programs (and systems)?&lt;/li>
&lt;li>Which traits draw the hard line between &amp;ldquo;Functional&amp;rdquo; and other kinds of
programs (and systems)?&lt;/li>
&lt;li>Which traits &lt;em>really&lt;/em> matter?&lt;/li>
&lt;li>Why would you even want any of it in the first place?&lt;/li>
&lt;/ul>
&lt;p>And will we really achieve world domination with FP? (Yes, we will.)&lt;/p>
&lt;h2 id="is-it-mathematics">Is it Mathematics?&lt;/h2>
&lt;p>Is it about writing &amp;ldquo;pure&amp;rdquo; functions?&lt;/p>
&lt;p>This is a bit of a tautology. A function is &amp;ldquo;pure&amp;rdquo; by definition. It specifies
a fixed mapping of an input domain to an output domain. When invoked, it
changes nothing about the state of the world. Which begs the question, how can
a thing that &lt;em>does&lt;/em> nothing be computationally useful? (Spoiler: it isn&amp;rsquo;t in
isolation, unless of course, you figure out a way to use the computational
uselessness to turn staggeringly larger amounts of electricity into progressively
smaller fragments of your imagination, on a blockchain somewhere). But I digress&amp;hellip;&lt;/p>
&lt;p>Must we further also have &amp;ldquo;first-class&amp;rdquo; functions?&lt;/p>
&lt;p>Ones that we can pass around as values? This lets us describe all manner of
deferred computations, including un-computable absurdities like infinite sequences,
and partial applications that will sit around forever if we don&amp;rsquo;t complete them.&lt;/p>
&lt;p>And do we absolutely &lt;em>need&lt;/em> the solid ground of Lambda Calculus or Category
Theory to &lt;em>pre-exist&lt;/em>?&lt;/p>
&lt;p>That&amp;rsquo;s an easy one to refute, but these things have become rather holy grail-y
now. If you don&amp;rsquo;t know your monad laws, I&amp;rsquo;m sorry you&amp;rsquo;re not permitted near
functions any more. Oh, and what about proofs? These are in the process of
holy-grailing too&amp;hellip;&lt;/p>
&lt;h2 id="is-it-being-declarative">Is it being &amp;ldquo;declarative&amp;rdquo;?&lt;/h2>
&lt;p>Reduce/ravel/plan/derive/goal-seek?&lt;/p>
&lt;p>To be &amp;ldquo;declarative&amp;rdquo; is to want to write down a set of constraints or rules
or input-output relationships, and leave it to the system to figure out not
only &lt;em>what operations&lt;/em> to perform, but also &lt;em>how&lt;/em> and &lt;em>when&lt;/em> to perform them.&lt;/p>
&lt;p>The declarative world is thrice-removed from the &amp;ldquo;procedural&amp;rdquo; world, where we
have to tell the computer the what, how, and when in excruciating detail.&lt;/p>
&lt;p>SQL, Prolog, APL are seen as &amp;ldquo;highly declarative&amp;rdquo; languages. CSS is also a
highly declarative language (which, I feel, is why people have a really hard
time with it&amp;mdash;CSS is a &lt;em>constraint mechanism&lt;/em> but our minds are strongly
conditioned for procedural thinking).&lt;/p>
&lt;p>And maybe AI is the currently-ultimate expression of being &amp;ldquo;declarative&amp;rdquo;. We
declare that we don&amp;rsquo;t even know what to declare, and write a meta-declaration
and hope to Lambda that it will figure out the declaration that we should have
fed to the computer in the first place.&lt;/p>
&lt;h2 id="is-it-being-data-oriented">Is it being &amp;ldquo;data-oriented&amp;rdquo;?&lt;/h2>
&lt;p>viz., choosing to work in terms of inert &amp;ldquo;literal&amp;rdquo; entities like JSON or EDN
or XML or some structured binary encoding, instead of &amp;ldquo;live&amp;rdquo; objects with
internal state? Asynchronous message-passing instead of synchronous remote
procedure calls (whether through object graphs, or across computer networks)?&lt;/p>
&lt;p>Is it about adhering to the principle of referential transparency; i.e. the
equivalence of evaluated functions and literal data?&lt;/p>
&lt;h2 id="is-it-about-statelessness">Is it about &amp;ldquo;Statelessness&amp;rdquo;?&lt;/h2>
&lt;p>No machine registers? No place-oriented &amp;ldquo;mutable&amp;rdquo; state? No pointers? No
shared references? No side effects? Yes laziness? Yes append-only storage?
Yes event sourcing?&lt;/p>
&lt;h2 id="is-it-about-managed-environments">Is it about &amp;ldquo;managed&amp;rdquo; environments?&lt;/h2>
&lt;p>Language mechanisms that relieve us of the burden and perils of malloc/free?&lt;/p>
&lt;p>Garbage collection? Immutable persistent data structures? Type-directed
compile-time memory access/use control? Multi-Version Concurrency Control?&lt;/p>
&lt;p>Kubernetes?&lt;/p>
&lt;h2 id="is-it-about-following-some-discipline-and-maybe-automating-it">Is it about following some discipline, and maybe automating it?&lt;/h2>
&lt;p>viz. a &lt;em>system&lt;/em> or a design philosophy of doing things, such as:&lt;/p>
&lt;ul>
&lt;li>An accountant-like state management practice.&lt;/li>
&lt;li>Carefully manipulating state only when absolutely necessary.&lt;/li>
&lt;li>Hard-wiring FP traits into a programming language / system.&lt;/li>
&lt;li>Choosing a strict single-process, non-branching, forward-looping-only
method of flow control.&lt;/li>
&lt;li>Having standard, highly general purpose compositional interfaces oriented
around streaming data flow?&lt;/li>
&lt;li>Eiffel-like Design-By-Contract? (Which is surprisingly &amp;ldquo;functional&amp;rdquo;.)&lt;/li>
&lt;li>Continuation-passing style?&lt;/li>
&lt;li>&amp;hellip; etc?&lt;/li>
&lt;/ul>
&lt;h2 id="my-2-nano-btc-on-the-matter">My 2 nano BTC on the matter&lt;/h2>
&lt;p>I think all of our popular programming systems are object-oriented &lt;em>and&lt;/em>
imperative by default, whether explicitly or implicitly. Now they all seem
to be adding &amp;ldquo;functional&amp;rdquo; looking features too. But to me, the functional-ness
of a language (or a system) is not about the feature set, but fundamentally
about its default (automatic) relationship with The State (of the world).&lt;/p>
&lt;p>&lt;strong>The &amp;ldquo;Object-Oriented&amp;rdquo; way&lt;/strong> inexorably pushes us to clone reality.&lt;/p>
&lt;p>We ingest and manage as much state and behaviour as possible, in order to
emulate the world. This, by construction, requires us to operate based on
theories and assumptions (internal state) doomed to always lag and diverge
from reality. In other words, it&amp;rsquo;s a synchronization problem mixed with the
impossible ideal of wanting to make the actual run-time look like the apparent
run-time. Concurrency quickly reveals the difficulties of trying this.&lt;/p>
&lt;p>&lt;strong>The &amp;ldquo;Imperative&amp;rdquo; way&lt;/strong> is more like doing open heart surgery.&lt;/p>
&lt;p>We have to get in there and manually orchestrate control flow, interrupt things,
and get the whole of it to mutate in-place &lt;em>while it is running&lt;/em>. The race
condition is always imminent&amp;mdash;will we close first, or will it stop first?
We never &lt;em>really&lt;/em> know if the seemingly routine procedure will cause something
totally unrelated to blow up in our faces this time around. Meanwhile we have
very sharp instruments in hand, and have to do a lot of it by &lt;em>fingerspitzengefühl&lt;/em>
because half the time we literally can&amp;rsquo;t see where to cut or clamp or suture.
I didn&amp;rsquo;t train for this but I hope you have. For at least 10 years. You have,
right? &amp;hellip; Right?&lt;/p>
&lt;p>&lt;strong>The &amp;ldquo;Functional&amp;rdquo; way&lt;/strong> wants to completely invert these models.&lt;/p>
&lt;p>It tries to expel all system state from inside to the outside. In so doing, it
immerses itself in world-state and tries to be a new conduit for different
parts of outside reality to communicate, hoping to make it behave to our liking.
This, by construction, forces us to think explicitly in terms of events
(discrete sensing and sequencing of world updates, i.e. facts), messaging
(encoding and transmitting facts as data), and time (asynchronicity, consistency,
consensus).&lt;/p>
&lt;p>The functional way is also totally different from how we experience the world.
The world is a concurrent, recurrent, parallel, fractal distributed system of
systems. And it is also stochastic and full of discontinuities. We have evolved
to form just-about-good-enough models of reality in our heads, in very bounded
contexts, to the extent necessary for survival. These internal models smooth
over all sorts of discontinuities, resist change while survival odds feel good,
and determine how we behave regardless of what might actually be out there.
We learn imperatively by poking and prodding the world around us while it hums
along. I think this is why it takes serious effort to learn the &amp;ldquo;functional&amp;rdquo;
way. We have to upend our entire mental model of how to do things in the world.&lt;/p>
&lt;p>&lt;strong>Maybe pure data at rest&lt;/strong> is the only truly &amp;ldquo;functional&amp;rdquo; thing?&lt;/p>
&lt;p>Maybe not. Like a pure function, pure data at rest does nothing and so is
useless to us when dormant. Besides, it is &amp;ldquo;pure&amp;rdquo; &lt;em>only&lt;/em> for the duration
entropy permits its complete un-corrupted recovery. Ultimately, the laws of
Physics will always win. To muddy the waters a bit more, even the purest of
pure functional systems contain state; signals in flight or some in-progress
computation.&lt;/p>
&lt;p>The only saving grace is that in a highly functional system, any run-time
state is entirely recoverable, reproducible, discrete, and isolated.&lt;/p>
&lt;p>&lt;strong>All said, everything mutates sooner or later.&lt;/strong>&lt;/p>
&lt;p>I don&amp;rsquo;t know how to navigate this, except to remind myself about The Thing
That Actually Matters&amp;hellip; to always remember that The State is the frenemy.&lt;/p>
&lt;p>So while it pleases me that so many wish to eagerly embrace the Functional Way,
it is good to be soberly mindful of scopes, lifetimes, margins, error budgets,
and bounds of reality (state) and of data (information about reality). Good
situational awareness will lead us to build highly functional systems that
keep The State where it belongs, and still do useful things with it.&lt;/p>
&lt;p>And all &lt;em>that&lt;/em> said, I leave you with this prayer:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-text" data-lang="text">O Lambda the Ultimate,
bless the reader of these words.
That their core be functional,
and their functions be pure.
That their data be immutable,
so they may know the value of values.
That their systems be composable,
so they may grow and scale with grace.
That their States only mutate
in pleasantly surprising ways.
For otherwise nothing lives.
Nothing evolves.
In the name of the alpha,
the beta, and the eta...
(λx.x x) (λx.x x)
&lt;/code>&lt;/pre>&lt;/div></content></item><item><title>Poor man's Reader App with Pandoc and Bash</title><link>/posts/reader-app-pandoc-bash/</link><pubDate>Thu, 10 Feb 2022 22:10:43 +0530</pubDate><guid>/posts/reader-app-pandoc-bash/</guid><description>&lt;p>Throwback, June 27, 2020.&lt;/p>
&lt;p>Every so often, I want to avoid opening a website in a browser, for &amp;hellip; reasons.&lt;/p>
&lt;p>Curl alone presents too much html. I want to try and read stuff.&lt;/p>
&lt;p>Today, I was playing with Igor Chubin&amp;rsquo;s &lt;strong>awesome&lt;/strong> terminal services (wttr.in,
cht.sh etc.), and it hit me:&lt;/p>
&lt;p>&amp;ldquo;WAIT, there&amp;rsquo;s pandoc, what if I just &amp;hellip; &amp;quot;&lt;/p></description><content>&lt;p>Throwback, June 27, 2020.&lt;/p>
&lt;p>Every so often, I want to avoid opening a website in a browser, for &amp;hellip; reasons.&lt;/p>
&lt;p>Curl alone presents too much html. I want to try and read stuff.&lt;/p>
&lt;p>Today, I was playing with Igor Chubin&amp;rsquo;s &lt;strong>awesome&lt;/strong> terminal services (wttr.in,
cht.sh etc.), and it hit me:&lt;/p>
&lt;p>&amp;ldquo;WAIT, there&amp;rsquo;s pandoc, what if I just &amp;hellip; &amp;quot;&lt;/p>
&lt;hr>
&lt;p>&amp;hellip;
&amp;hellip;
&amp;hellip; and an hour later&amp;hellip; a terrible idea manifested itself.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">www_to_md&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
pandoc --wrap&lt;span style="color:#f92672">=&lt;/span>none -f html -t markdown &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>1&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
drop_noise&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;span style="color:#75715e"># remove pesky divs&lt;/span>
grep -v -E &lt;span style="color:#e6db74">&amp;#34;(&amp;lt;div|&amp;lt;/div).*[&amp;gt;]?|*.&amp;gt;&amp;#34;&lt;/span> |
&lt;span style="color:#75715e"># squeeze multiple blank lines into one&lt;/span>
cat -s
&lt;span style="color:#f92672">}&lt;/span>
cache_site&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
local sitecache&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>1:?&lt;span style="color:#e6db74">&amp;#39;Fail. Path to create cache.&amp;#39;&lt;/span>&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
local mdfilename&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>2&lt;span style="color:#66d9ef">:-&lt;/span>&lt;span style="color:#e6db74">&amp;#39;this.md&amp;#39;&lt;/span>&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
local evict_cache_qmark&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>3&lt;span style="color:#66d9ef">:-&lt;/span>no&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
mkdir -p &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>sitecache&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> -f &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>sitecache&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">/&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>mdfilename&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>evict_cache_qmark&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;no&amp;#34;&lt;/span> &lt;span style="color:#f92672">]]&lt;/span>
&lt;span style="color:#66d9ef">then&lt;/span> tee
&lt;span style="color:#66d9ef">else&lt;/span> tee &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>sitecache&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">/&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>mdfilename&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;span style="color:#66d9ef">fi&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
panwww&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
local siteurl&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>1&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
local evict_cache_qmark&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>2&lt;span style="color:#66d9ef">:-&lt;/span>no&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
local sitename&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>siteurl/http*:&lt;span style="color:#ae81ff">\/\/&lt;/span>/www.&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
local sitecache&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;/tmp/panwwwcache/&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>sitename&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
local mdfilename&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;this.md&amp;#34;&lt;/span>
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">[[&lt;/span> -f &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>sitecache&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">/&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>mdfilename&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>evict_cache_qmark&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;no&amp;#34;&lt;/span> &lt;span style="color:#f92672">]]&lt;/span>
&lt;span style="color:#66d9ef">then&lt;/span> local cmd&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;cat &lt;/span>&lt;span style="color:#e6db74">${&lt;/span>sitecache&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">/&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>mdfilename&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;span style="color:#66d9ef">else&lt;/span> local cmd&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;www_to_md &lt;/span>&lt;span style="color:#e6db74">${&lt;/span>siteurl&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;span style="color:#66d9ef">fi&lt;/span>
$cmd | drop_noise | cache_site &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>sitecache&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>mdfilename&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">${&lt;/span>evict_cache_qmark&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>
&lt;span style="color:#f92672">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>so that &amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">panwww &lt;span style="color:#e6db74">&amp;#34;https://www.recurse.com/&amp;#34;&lt;/span> | less &lt;span style="color:#75715e"># fetches site the first time&lt;/span>
panwww &lt;span style="color:#e6db74">&amp;#34;https://www.recurse.com/&amp;#34;&lt;/span> | less &lt;span style="color:#75715e"># looks up &amp;#34;cache&amp;#34;&lt;/span>
panwww &lt;span style="color:#e6db74">&amp;#34;https://www.recurse.com/&amp;#34;&lt;/span> &lt;span style="color:#e6db74">&amp;#34;refetch&amp;#34;&lt;/span> | less
&lt;/code>&lt;/pre>&lt;/div></content></item></channel></rss>